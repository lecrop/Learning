<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Francisco Porcel-Pastrana">

<title>Learning - Bulk RNAseq</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Learning</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Búsqueda en BBDDs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./RNAseq.html" rel="" target="" aria-current="page">
 <span class="menu-text">Bulk RNAseq</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./AS_Analysis.html" rel="" target="">
 <span class="menu-text">Alternative Splicing</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="4">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#salmon" id="toc-salmon" class="nav-link active" data-scroll-target="#salmon"><span class="header-section-number">1</span> Salmon</a>
  <ul class="collapse">
  <li><a href="#generar-el-genoma-de-referencia" id="toc-generar-el-genoma-de-referencia" class="nav-link" data-scroll-target="#generar-el-genoma-de-referencia"><span class="header-section-number">1.1</span> Generar el genoma de referencia</a></li>
  <li><a href="#comprobar-la-calidad-de-las-muestras-secuenciadas-fastqc" id="toc-comprobar-la-calidad-de-las-muestras-secuenciadas-fastqc" class="nav-link" data-scroll-target="#comprobar-la-calidad-de-las-muestras-secuenciadas-fastqc"><span class="header-section-number">1.2</span> Comprobar la calidad de las muestras secuenciadas (fastQC)</a></li>
  <li><a href="#alineamiento-y-cuantificación-con-salmon" id="toc-alineamiento-y-cuantificación-con-salmon" class="nav-link" data-scroll-target="#alineamiento-y-cuantificación-con-salmon"><span class="header-section-number">1.3</span> Alineamiento y cuantificación con Salmon</a></li>
  </ul></li>
  <li><a href="#compilacion-de-datos-con-tximport-r" id="toc-compilacion-de-datos-con-tximport-r" class="nav-link" data-scroll-target="#compilacion-de-datos-con-tximport-r"><span class="header-section-number">2</span> Compilacion de datos con Tximport (R)</a></li>
  <li><a href="#workflow-deseq2" id="toc-workflow-deseq2" class="nav-link" data-scroll-target="#workflow-deseq2"><span class="header-section-number">3</span> Workflow DESeq2</a>
  <ul class="collapse">
  <li><a href="#importar-datos" id="toc-importar-datos" class="nav-link" data-scroll-target="#importar-datos"><span class="header-section-number">3.1</span> Importar datos</a></li>
  <li><a href="#preprocesamiento-prefiltrado" id="toc-preprocesamiento-prefiltrado" class="nav-link" data-scroll-target="#preprocesamiento-prefiltrado"><span class="header-section-number">3.2</span> Preprocesamiento (prefiltrado)</a></li>
  <li><a href="#análisis-de-calidad-de-las-muestras-qc-analyses" id="toc-análisis-de-calidad-de-las-muestras-qc-analyses" class="nav-link" data-scroll-target="#análisis-de-calidad-de-las-muestras-qc-analyses"><span class="header-section-number">3.3</span> Análisis de calidad de las muestras (QC Analyses)</a>
  <ul class="collapse">
  <li><a href="#normalización" id="toc-normalización" class="nav-link" data-scroll-target="#normalización"><span class="header-section-number">3.3.1</span> Normalización</a></li>
  <li><a href="#análisis-de-clustering-no-supervisado" id="toc-análisis-de-clustering-no-supervisado" class="nav-link" data-scroll-target="#análisis-de-clustering-no-supervisado"><span class="header-section-number">3.3.2</span> Análisis de clustering no supervisado</a></li>
  </ul></li>
  <li><a href="#análisis-de-expresión-diferencial-de-analysis" id="toc-análisis-de-expresión-diferencial-de-analysis" class="nav-link" data-scroll-target="#análisis-de-expresión-diferencial-de-analysis"><span class="header-section-number">3.4</span> Análisis de Expresión diferencial (DE analysis)</a>
  <ul class="collapse">
  <li><a href="#modelado-de-las-counts-para-cada-gen-y-fold-changes-corregidos" id="toc-modelado-de-las-counts-para-cada-gen-y-fold-changes-corregidos" class="nav-link" data-scroll-target="#modelado-de-las-counts-para-cada-gen-y-fold-changes-corregidos"><span class="header-section-number">3.4.1</span> Modelado de las counts para cada gen y Fold changes corregidos</a></li>
  <li><a href="#evaluación-de-la-expresión-diferencial" id="toc-evaluación-de-la-expresión-diferencial" class="nav-link" data-scroll-target="#evaluación-de-la-expresión-diferencial"><span class="header-section-number">3.4.2</span> Evaluación de la expresión diferencial</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#downstream-analysis-expñoración-de-resultados-usando-la-guía-de-clusterprofiler" id="toc-downstream-analysis-expñoración-de-resultados-usando-la-guía-de-clusterprofiler" class="nav-link" data-scroll-target="#downstream-analysis-expñoración-de-resultados-usando-la-guía-de-clusterprofiler"><span class="header-section-number">4</span> DownStream analysis: Expñoración de resultados usando la guía de ClusterProfiler</a>
  <ul class="collapse">
  <li><a href="#formato-de-datos" id="toc-formato-de-datos" class="nav-link" data-scroll-target="#formato-de-datos"><span class="header-section-number">4.1</span> Formato de datos</a></li>
  <li><a href="#gene-ontology-go-analysis" id="toc-gene-ontology-go-analysis" class="nav-link" data-scroll-target="#gene-ontology-go-analysis"><span class="header-section-number">4.2</span> Gene Ontology (GO) Analysis</a>
  <ul class="collapse">
  <li><a href="#sobreexpresión-de-go" id="toc-sobreexpresión-de-go" class="nav-link" data-scroll-target="#sobreexpresión-de-go"><span class="header-section-number">4.2.1</span> Sobreexpresión de GO</a></li>
  <li><a href="#análisis-de-enriquecimiento" id="toc-análisis-de-enriquecimiento" class="nav-link" data-scroll-target="#análisis-de-enriquecimiento"><span class="header-section-number">4.2.2</span> Análisis de enriquecimiento</a></li>
  </ul></li>
  <li><a href="#kegg-analysis" id="toc-kegg-analysis" class="nav-link" data-scroll-target="#kegg-analysis"><span class="header-section-number">4.3</span> Kegg Analysis</a>
  <ul class="collapse">
  <li><a href="#análisis-de-sobre-representación-de-ruta-kegg" id="toc-análisis-de-sobre-representación-de-ruta-kegg" class="nav-link" data-scroll-target="#análisis-de-sobre-representación-de-ruta-kegg"><span class="header-section-number">4.3.1</span> Análisis de sobre-representación de ruta Kegg</a></li>
  <li><a href="#análisis-de-enriquecimiento-gsea-de-ruta-kegg" id="toc-análisis-de-enriquecimiento-gsea-de-ruta-kegg" class="nav-link" data-scroll-target="#análisis-de-enriquecimiento-gsea-de-ruta-kegg"><span class="header-section-number">4.3.2</span> Análisis de enriquecimiento (GSEA) de ruta Kegg</a></li>
  </ul></li>
  <li><a href="#gsea-analisis-msigdb" id="toc-gsea-analisis-msigdb" class="nav-link" data-scroll-target="#gsea-analisis-msigdb"><span class="header-section-number">4.4</span> GSEA Analisis (MSigDb)</a></li>
  <li><a href="#network-of-cancer-genes-ncg-analisis" id="toc-network-of-cancer-genes-ncg-analisis" class="nav-link" data-scroll-target="#network-of-cancer-genes-ncg-analisis"><span class="header-section-number">4.5</span> Network of Cancer Genes (NCG) Analisis</a></li>
  <li><a href="#graficando-los-análisis-de-over-representation-y-gsea" id="toc-graficando-los-análisis-de-over-representation-y-gsea" class="nav-link" data-scroll-target="#graficando-los-análisis-de-over-representation-y-gsea"><span class="header-section-number">4.6</span> Graficando los análisis de Over-representation y GSEA</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Bulk RNAseq</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Francisco Porcel-Pastrana </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>#Instalación de Mamba y Salmon (en terminal) En un primer momento íbamos a instalar <a href="https://doi.org/10.1038/nmeth.4197">Salmon</a> (<a href="https://salmon.readthedocs.io/en/latest/salmon.html">enlace a documentacion GitHub de Salmon</a>) con Anaconda pero daba problemas a la hora de realizar la instalación de Salmon. Luego procedimos a la instalación de Mamba (<a href="https://mamba.readthedocs.io/en/latest/installation.html">Enlace a página de Mamaba</a> y de e <a href="https://mamba.readthedocs.io/en/latest/mamba-installation.html#mamba-install">instalación</a>) a través de Anaconda pero crasheaba en la instalación. Buscando en webs hemos encontrado que no es recomendable tener instalado Anaconda y Mamba a la vez de manera que hemos borrado los repositorios de Anacoda del servidor (y de miniconda, que tener miniconda y Anaconda no tenia ningún sentido porque Anaconda es más rápido y grande que miniconda de manera que era absurdo). Para eliminar tanto Anaconda (que se encontraba e la carpeta anaconda3) como Miniconda (que se encontraba en la carpeta miniconda3) hemos usado los siguientes comandos:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Todo lo hecho a partir de aquí está en Terminal_9-19-23.txt</em></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>rm <span class="sc">-</span>rf anaconda3<span class="sc">/</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>rm <span class="sc">-</span>rf miniconda3<span class="sc">/</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ya podemos proceder a la instalación de Mamba. Es preferible la instalación de Mamba porque es como Anaconda pero con esteroides (según el bioinformático de Manuel Irimia). En primer lugar vamos a instalar Mamba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>curl <span class="sc">-</span>L <span class="sc">-</span>O <span class="st">"https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A continuación podemos instalar el programa Salmon para el análisis de Bulk RNAseq con los siguientes comandos. Primero comprobamos qué versiones podemos instalar (para descargarnos la última versión):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mamba search salmon</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nos saldrá un listado de versiones disponibles para la instalación de Salmon y tendremos que instalar la versión que queramos (en nuestro caso vamos a instalar la última versión, que corresponde a la 1.10.3):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mamba create <span class="sc">-</span>n salmon salmon<span class="ot">=</span><span class="dv">1</span>.<span class="fl">10.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Es una buena práctica comprobar que se ha instalado de forma adecuada (activando Salmon y comprobando la versión:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>mamba activate salmon</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>salmon –version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El output será el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>salmon <span class="dv">1</span>.<span class="fl">10.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cerramos salmon:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>salmon deactivate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Además es buena práctica también comprobar que las instalaciones que hemos hecho previamente (en nuestro caso matt, vast-tools y SRA-Toolkit) no se han visto afectadas por la instalación de Mamba:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>vast<span class="sc">-</span>tools –help</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>matt –help</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>fastq<span class="sc">-</span>dump <span class="sc">--</span>help</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ya podemos proceder a usar Salmon.</p>
<section id="salmon" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Salmon</h1>
<p>Para generar los alineamientos y cuantificación primero tenemos que tener un genoma de referencia.</p>
<section id="generar-el-genoma-de-referencia" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="generar-el-genoma-de-referencia"><span class="header-section-number">1.1</span> Generar el genoma de referencia</h2>
<p>Para descarganos el genoma de referencia que queramos evaluar vamos a utilizar la base de datos Ensembl. En la web accedemos a la especie que queramos (en nuestro ejemplo Homo sapiens).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/picture17.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Imagen 1</figcaption>
</figure>
</div>
<p>A continuación, es la sección de Gene_annotation seleccionamos la opción de descargarnos bases de datos en formato FASTA.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/picture18.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Imagen 2</figcaption>
</figure>
</div>
<p>Esto nos llevará un repositorio donde tendremos distintas referencias del genoma:</p>
<ul>
<li>Transcritos (cdna/)</li>
<li>Regiones codificantes (cds/)</li>
<li>Regiones del genoma/cromosomas (dna/)</li>
<li>Parece un índice del anterior (dna/index)</li>
<li>Non-coding RNA (ncrna/)</li>
<li>Péptidos para proteómica (pep/)</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/picture19.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Imagen 3</figcaption>
</figure>
</div>
<p>Lo habitual para cuantificar genes por RNAseq es descargarse los transcritos de manera que vamos a seleccionar “cdna/” y dentro de las opciones que hay en este en nuestro caso hemos elegido el indicado con rojo.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/picture20.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Imagen 4</figcaption>
</figure>
</div>
<p>Tenemos que clickar con el botón derecho y copiar la dirección de enlace para en nuestro terminal descargarnos este archivo con la función <code>wget</code>.</p>
<p>Lo más conveniente para llevar a cabo la descarga de genomas de referencia es crear una carpeta para esto, de manera que la creamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>mkdir Genome_Refs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Vamos a esta carpeta y usamos el comando <code>wget</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>wget https<span class="sc">:</span><span class="er">//</span>ftp.ensembl.org<span class="sc">/</span>pub<span class="sc">/</span>release<span class="dv">-110</span><span class="sc">/</span>fasta<span class="sc">/</span>homo_sapiens<span class="sc">/</span>cdna<span class="sc">/</span>Homo_sapieCh38.cdna.all.fa.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esto nos descarga el <code>.gz</code> del genoma elegido en nuestra carpeta. Ahora generamos el índice con salmon:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>salmon index <span class="sc">-</span>t Homo_sapiens.GRCh38.cdna.all.fa.gz <span class="sc">-</span>i Transcriptome_Index_Ref_Hsa_v38</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Con este comando decimos con “-t &lt;archivo.gz&gt;” el archivo que tiene que leer, que en nuestro caso es el que nos acabamos de descargar de Ensembl. Con el argumento -i <nombre_índice> indicamos el nombre que le vamos a poner a este índice (el archivo que se va a generar). <strong>Es muy importante poner un nombre que permita discernir bien la especie, versión y tipo de alineamiento que permite hacer, en nuestro caso son todos los trancritos de la versión 38 del genoma humano así que le he puesto <code>Transcriptome_Index_Ref_Hsa_v38</code>. <span class="math inline">Este es el nombre que luego usaremos en la cuantificación</span></strong>. Ya que estaba me he dejado descargado los genomas de ratón (v.39) y rata (v.7.2) por si los necesitamos en algún momento.</nombre_índice></p>
</section>
<section id="comprobar-la-calidad-de-las-muestras-secuenciadas-fastqc" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="comprobar-la-calidad-de-las-muestras-secuenciadas-fastqc"><span class="header-section-number">1.2</span> Comprobar la calidad de las muestras secuenciadas (fastQC)</h2>
<p>Es de buena praxis comprobar la calidad de los resultados de la secuenciación debido a que esta puede introducir algún tipo de bias interno a la misma. Por ejemplo, un bias a corregir es el de contenido de GC, lo cual se corrige en el siguiente paso con salmon. Para correr un archivo hay que usar el siguiente comando:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fastqc Basal_1_1.fastq.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si queremos que se nos guarde en un directorio, primero tenemos que crearlo de firma manual y luego utilizar el argumento <code>-o &lt;nombre_del_directorio&gt;</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mkdir resultados_fastqc</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>fastqc <span class="sc">-</span>o resultados_fastqc Basal_1_1.fastq.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Esto hace que se generen unos archivos HTML que nos llevará a una página en la que podemos ver la calidad de la muestra. Para conocer lo que significa cada uno de los apartados podemos acceder a este <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/3%20Analysis%20Modules/">enlace</a> y si queremos también tenemos un <a href="https://www.youtube.com/watch?v=bz93ReOv87Y&amp;ab_channel=BabrahamBioinf">video tutorial</a> donde se explica cada cosa. Si tenemos muchas muestras y queremos verlas todas juntas podemos utilizar la herramienta <a href="https://multiqc.info/">multiQC</a>. Para utilizar esta herramienta la hemos instalado desde mamba y para ejecutarla (suponiendo que hemos generado la carpeta anterior “resultados_fastqc”) tenemos que ejecutar el comando seguido del nombre de la carpeta.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>multiqc resultados_fastqc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si estamos en la misma carpeta donde se han generado todos los archivos fastqc (es decir, dentro de “resultados_fastqc” para nuestro ejemplo) el comando sería el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>multiqc .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>(hay un script hecho en el terminal para usarlo como plantilla para que lo haga automático todo).</p>
</div>
</div>
</section>
<section id="alineamiento-y-cuantificación-con-salmon" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="alineamiento-y-cuantificación-con-salmon"><span class="header-section-number">1.3</span> Alineamiento y cuantificación con Salmon</h2>
<p>Para realizar la cuantificación tenemos que tener en cuenta el tipo de secuenciación que hemos realizado. La secuenciación para una muestra ha podido ser Single-End o Paired-End. Asimismo para una misma muestra se han podido secuenciar una única réplica o dos replicas para una mayor fiabilidad de la secuenciación. De esta manera, se han podido generar los siguientes archivos (se va a usar el nombre <em>sample</em> de ejemplo para explicar el número de archivos que podemos tener):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/Picture21.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Imagen 5</figcaption>
</figure>
</div>
<p>Teniendo esto en cuenta vamos a cuantificar nuestra muestras con la función “salmon quant” en el formato <code>mapping-based mode</code> (recordatorio de que tenemos que estar en el entorno salmon para hacer esto, el cual se activa con el comando “mamba actívate salmon” y que tenemos que estar en la carpeta donde tengamos las muestras descargadas). Para llevar a cabo la cuantificación el imput variará en función de la elección que hayamos cogido. Si hemos hecho Opción 1 o 2, es decir, solo hemos secuenciado una réplica de cada muestra, tenemos que usar el comando <code>-r &lt;argumento&gt;</code>. Para la Opción 1 el comando para la cuantificación sería el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i transcripts_index <span class="sc">-</span>l A <span class="sc">-</span>r Sample_1.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Donde: - <code>-i &lt;opción&gt;</code>. Indica el genoma de referencia para hacer el mapeo (en nuestro ejemplo sería el nombre de la dirección del genoma humano que hemos descargado previamente, “/home/raul/Genome_Refs/Transcriptome_Index_Ref_Hsa_v38/”). Esta parte del comando será la misma para los siguientes opciones. - <code>-l &lt;opción&gt;</code>. Indica el formato en el que se han generado las librerías. Nosotros vamos a usar siempre la opción “A”, que es una opción de salmon que identifica el tipo de librería que hemos utilizado. Esta parte del comando será la misma para los siguientes opciones. - <code>-r &lt;nombre_muestra&gt;</code>. Aquí indicamos el nombre de nuestra muestra. Este argumento es el que variará posteriormente para analizar las distintas opciones. - <code>--validateMapping</code>. Permite que Salmon realice una validación adicional de los emparejamientos (mappings) entre las lecturas y las secuencias de referencia durante el proceso de cuantificación de expresión génica. Esta parte del comando será la misma para los siguientes opciones. - <code>-o &lt;nombre_carpeta&gt;</code>. Este argumento genera una carpeta con el nombre que pongamos tras el comando -o. Esta parte del comando será la misma para los siguientes</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>NOTA: Si en el fastQC hemos tenido un enriquecimiento en GC tenemos que llevar a cabo una corrección de este error, de manera que tenemos que deberíamos añadir al comando anterior (independientemente de la opción de tipo de muestra que tengamos) el argumento <code>--gcBias</code></p>
</div>
</div>
<p>Para la Opción 2 el comando para la cuantificación sería el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i transcripts_index <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Sample_1_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Sample_1_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Donde: - <code>-i &lt;opción&gt;</code>. Explicado en opción 1. - <code>-l &lt;opción&gt;</code>. Explicado en opción 1. - <code>-1 &lt;nombre_muestra_1_1&gt;</code>. Aquí indicamos el nombre del primer sentido de secuenciación de nuestra muestra.<br>
- <code>-2 &lt;nombre_muestra_1_2&gt;</code>. Aquí indicamos el nombre del segundo sentido de secuenciación de nuestra muestra. - <code>--validateMapping</code>. Explicado en opción 1. - <code>-o &lt;nombre_carpeta&gt;</code>. Explicado en opción 1.</p>
<p>Para la Opción 3 el comando para la cuantificación sería el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i transcripts_index <span class="sc">-</span>l A <span class="sc">-</span>r Sample_Rep1.fastq.gz Sample_Rep2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Donde: - <code>-i &lt;opción&gt;</code>. Explicado en opción 1. - <code>-l &lt;opción&gt;</code>. Explicado en opción 1. - <code>-r &lt;nombre_muestra_Replica_1 nombre_muestra_Replica_2&gt;</code>. Aquí incluimos las dos replicas de nuestra muestra.<br>
- <code>--validateMapping</code>. Explicado en opción 1. - <code>-o &lt;nombre_carpeta&gt;</code>. Explicado en opción 1.</p>
<p>Para la Opción 4 el comando para la cuantificación sería el siguiente:</p>
<p>Donde: - <code>-i &lt;opción&gt;</code>. Explicado en opción 1. - <code>-l &lt;opción&gt;</code>. Explicado en opción 1. - <code>-r &lt;nombre_muestra_Replica_1 nombre_muestra_Replica_2&gt;</code>. Aquí incluimos las dos replicas de nuestra muestra. - <code>-2 &lt;nombre_muestra_Replica_1_2 nombre_muestra_Replica_2_2&gt;</code>. Aquí incluimos las dos segundas replicas de nuestra muestra. Es muy importante que las réplicas se ordenen igual que en el primer argumento <code>-1</code>. - <code>--validateMapping</code>. Explicado en opción 1. - <code>-o &lt;nombre_carpeta&gt;</code>. Explicado en opción 1.</p>
<p>Tras la explicación teórica, continuamos con nuestro archivo de ejemplo. Para procesar la primera muestra (Basal_1), el comando sería el siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Basal_1_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Basal_1_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Código para todas las muestras a la vez
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>Para correr todas las muestras a la vez tenemos la opción de crear un script sencillito de bash para que se ejecuten todas las muestras que tenemos. Lo más cómodo es abrir un entorno screen para trabajar allí y luego poder desvincularlo por si nos tenemos que ir o algo, para que no se pare. Una vez abierto el screen, tenemos que abrir el entono salmon (mamba actívate salmon). Los pasos son los siguientes:</p>
<ol type="1">
<li>Crear el script con el editor de texto <code>nano</code></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>nano run_Salmon_Mapping.bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Esto nos abre una pantalla en la que podemos escribir, ahí podremos escribir las funciones que queramos que se ejecuten:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 1</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Basal_1_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Basal_1_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant<span class="sc">/</span>Basal_1</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Basal_1 procesado"</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 2</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Basal_2_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Basal_2_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant <span class="sc">/</span>Basal_2</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Basal_2 procesado"</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 3</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Basal_3_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Basal_3_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant<span class="sc">/</span>Basal_3</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Basal_3 procesado"</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 4</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Luminal_1_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Luminal_1_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant<span class="sc">/</span>Luminal_1</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Luminal_1 procesado"</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 5</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Luminal_2_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Luminal_2_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant Luminal_2</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Luminal_2 procesado"</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Comando para procesar el archivo 6</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>salmon quant <span class="sc">-</span>i <span class="sc">/</span>home<span class="sc">/</span>raul<span class="sc">/</span>Genome_Refs<span class="sc">/</span>Transcriptome_Index_Ref_Hsa_v38<span class="sc">/</span> <span class="sc">-</span>l A <span class="sc">-</span><span class="dv">1</span> Luminal_3_1.fastq.gz <span class="sc">-</span><span class="dv">2</span> Luminal_3_2.fastq.gz <span class="sc">--</span>validateMappings <span class="sc">-</span>o transcripts_quant<span class="sc">/</span>Luminal_3</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Luminal_3 procesado"</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>echo <span class="st">"Procesamiento completado para todos los archivos"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Esto hará que se procese un archivo tras otro y se vaya guardando en una subcarpeta dentro de la carpeta que se va a crear <code>transcripts_quant/subcarpeta_por_muestra</code>, porque sino se sobreescribirá siempre la misma carpeta (habla la voz de la experiencia amigo/a….) y que cada vez que acabe un archivo nos salga un mensaje de que ya está procesado y cuando acaba nos dirá que ya se ha completado el proceso. Para guardar el archivo sigue estos pasos: 1) Presiona <code>Ctrl + O</code> (mantén presionada la tecla Control y luego presiona la letra “O”). Te preguntará <code>File Name to Write</code>. Presiona “Enter” para confirmar el nombre del archivo; 2) Para salir del editor nano, presiona <code>Ctrl + X</code>.</li>
</ul>
<ol start="2" type="1">
<li>Para ejecutar el archivo debemos asegurarnos de tener los permisos de ejecución del script:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>Chmod <span class="sc">+</span>x run_Salmon_Mapping.bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Ya podemos ejecutar el script (debemos de estar en la carpeta que lo contenga y tener el entorno de salmon abierto con (mamba actívate salmon))</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>.<span class="sc">/</span>run_Salmon_Mapping.bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tras esto podremos hacer <code>Ctrl + a + d</code> para desvincular la sesión de <code>screen</code> y esperar a que acabe.</p>
</div>
</div>
</div>
<p>Los archivos <code>quant.sf</code> van a tener el siguiente contenido:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/Picture22.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Image 6</figcaption>
</figure>
</div>
<p>Las columnas tienen la siguiente interpretación. - <strong>Name</strong> - Es el nombre del transcrito objetivo proporcionado en la base de datos de transcritos de entrada (archivo FASTA). - <strong>Length</strong> - Es la longitud del transcrito objetivo en nucleótidos. - <strong>EffectiveLength</strong> - Es la longitud efectiva calculada del transcrito objetivo. Tiene en cuenta todos los factores que se están modelando y que afectarán a la probabilidad de muestreo de fragmentos de este transcrito, incluyendo la distribución de la longitud del fragmento y el sesgo específico de la secuencia y del fragmento gc (si se están modelando). - <strong>TPM</strong> - Es la estimación del salmón de la abundancia relativa de este transcrito en unidades de Transcritos Por Millón (TPM). TPM es la medida de abundancia relativa recomendada para el análisis posterior. - <strong>NumReads</strong> - Es la estimación de Salmon del número de lecturas que corresponden a cada transcrito cuantificado. Es una “estimación” en la medida en que es el número esperado de lecturas que se han originado a partir de cada transcrito dada la estructura de las lecturas de mapeo único y mapeo múltiple y las estimaciones de abundancia relativa para cada transcrito.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>Todo lo hecho a partir de aquí está en Terminal_9-20-23.txt</em></p>
</div>
</div>
<p>El siguiente paso va a ser unir todos los archivos <code>.sf</code> en el que tenemos la cuantificación de cada una de las muestras para generar la matriz de datos para hacer los análisis.</p>
<p>Al haber comparado con el transcriptoma de referencia, lo que nos va a generar salmon con cada uno de los archivos <code>.sf</code> es literalmente el transcriptoma, es decir, todos los transcritos de cada uno de los genes. Esto no es correcto analizarlo directamente. Es útil tener la información de cada uno de los transcritos de cada gen (especialmente si luego vamos a comparar con splicing alternativo) pero lo verdaderamente correcto es resumir y poner en conjunto la información de todos los transcrito para ver la expresión del gen en concreto. Para hacer esto tenemos que descargarnos un paquete de R que lo hace automáticamente. Además este paquete crea una matriz con todos los genes (en las filas) y todas las muestras que hemos analizado (en columnas) con salmon de manera que estaremos evaluando correctamente la expresión génica.</p>
</section>
</section>
<section id="compilacion-de-datos-con-tximport-r" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Compilacion de datos con Tximport (R)</h1>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>#A partir de aquí seguior en R (o RStudio)</p>
</div>
</div>
<p>Tenemos que instalar <a href="https://bioconductor.org/packages/release/bioc/vignettes/tximport/inst/doc/tximport.html#Salmon"><code>tximport</code></a> para llevar a cabo esta compilación de datos de transcritos para poder analizar expresión génica. Este paquete no tiene instalado genoma o transcriptoma de manera que lo mejor es que, como nosotros estamos usando genomas de referencia para las anotaciones obtenidos de Ensembl, tenemos que instalar el paquete <a href="https://bioconductor.org/packages/release/bioc/html/ensembldb.html"><code>ensembldb</code></a> con el cual podremos hacer llamada a las versiones de ensemble más actuales (que son las que estamos usando nosotros). Ambos son paquetes de Bioconductor, de manera que se tienen que instalar con <a href="https://bioconductor.org/install/"><code>BiocManager</code></a>. Por esto, entramos en R e instalamos los siguientes paquetes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"ensembldb"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"tximport"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Una vez instalados pasamos a importarlos datos de los archivos “quant.sf”. Para ello, lo primero que tenemos que cargar es el genoma de referencia que hayamos usado con el paquete “ensembldb” que acabamos de instalar. Vamos a activar (con <code>library(EnsDb.Hsapiens.v86)</code>) el paquete de la última versión de transcritos del genoma humano que hay disponible hasta la fecha (a 20/09/2023, la última versión del genoma humano es la 38, que se incluyó en Ensembl con la versión de actualización v.86):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnsDb.Hsapiens.v86)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Puede ser (como me pasó a mi) que nos de error y nos diga que no tenemos este paqute instalado (que supuestamente se ha tenido que instalar con el paquete <code>ensembl</code>), en ese caso primero lo instalamos y luego lo cargamos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"EnsDb.Hsapiens.v86"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnsDb.Hsapiens.v86)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout.note">
<p>Esta es la versión para el genoma humano, si tuvieramos el genoma de ratón o rata deberíamos buscar cuál es el genoma que debemos usar en función del que hayamos usado para el mapeo.</p>
</div>
<p>Ahora tenemos que crear la matrix donde <code>tximport</code> va a hacer la búsqueda de a qué gen corresponde cada transcrito para así calcular dicha expresión génica:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tx2gene<span class="ot">&lt;-</span><span class="fu">transcripts</span>(EnsDb.Hsapiens.v86, <span class="at">columns=</span><span class="fu">c</span>(<span class="st">"tx_id"</span>, <span class="st">"gene_id"</span>), <span class="at">return.type=</span><span class="st">"DataFrame"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled" title="¿Quieres curiosear sobre las posibilidades?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
¿Quieres curiosear sobre las posibilidades?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Para buscar más información acerca de como usar estos comandos o la información a recuperar debemos de irnos <a href="https://jorainer.github.io/ensembldb/reference/EnsDb-exonsBy.html">aquí</a>.</p>
</div>
</div>
<p>También tenemos que hacer llamada al paquete que vamos a utilizar para la compilación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tximport)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A continuación pasamos a crear una variable que contiene las rutas que contienen los archivos “quant.sf” generados con salmon:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>files<span class="ot">&lt;-</span><span class="fu">file.path</span>(<span class="st">"/home/raul/Fran/Basal_vs_Luminal/matt_analyses/rnaseq_data"</span>, <span class="st">"transcripts_quant"</span>, <span class="fu">c</span>(<span class="st">"Basal_1"</span>, <span class="st">"Basal_2"</span>, <span class="st">"Basal_3"</span>, <span class="st">"Luminal_1"</span>, <span class="st">"Luminal_2"</span>, <span class="st">"Luminal_3"</span>), <span class="st">"quant.sf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Con este código creamos una serie de rutas en la misma variable para todas las que tienen un directorio común (en nuestro caso, la carpeta “transcripts_quant”, es la que contiene las carpetas que a su vez contienen los archivos “quant.sf”). En el primer argumento tenemos que poner la dirección donde se encuentra la carpeta de interés (<code>“transcripts_quant”</code>). En el segundo argumento tenemos que poner el nombre de nuestra carpeta de interés (como son varias se pone en forma de cadena <code>c("Basal_1", "Basal_2", "Basal_3", "Luminal_1", "Luminal_2", "Luminal_3")</code>). En el tercer argumento tenemos que poner los nombres de las carpetas que se han generado con salmon para cada una de las muestras (en este caso son pocas y las hemos puesto con una cadena pero podemos crear un <code>.txt</code> o un <code>.csv</code> para cuando tengamos una larga lista de muestras analizadas). Por último, tenemos que poner el archivo <code>“quant.sf”</code> que es el que genera para cada muestra, de manera que esto es común.</p>
<p>A continuación ponemos a cada muestra el nombre que queramos.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(files)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Basal_1"</span>, <span class="st">"Basal_2"</span>, <span class="st">"Basal_3"</span>, <span class="st">"Luminal_1"</span>, <span class="st">"Luminal_2"</span>, <span class="st">"Luminal_3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aquí podríamos indicar el mismo archivo que en el argumento 3 del comando anterior.</p>
<p>Por último ejecutamos el comando de compilación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>txi.salmon<span class="ot">&lt;-</span><span class="fu">tximport</span>(files, <span class="at">type=</span><span class="st">"salmon"</span>, <span class="at">tx2gene=</span>tx2gene, <span class="at">ignoreTxVersion=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>La función <code>tximport()</code> llevará a cabo la compilación de datos. En el primer argumento pones donde hemos guardado las rutas donde están los archivos “quant.sf” (cuyas rutas hemos guardado en la variable <code>files</code>. En el segundo argumento (<code>type = xxxx</code>) ponemos el origen de los archivos, que en nuestro caso es siempre “salmon”. En el tercer argumento especificamos dónde se encuentran los identificadores para la compilación. Con el argumento <code>ignoreTxVersion=TRUE</code> hacemos que se puedan comparar porque salmon pone los transcritos con la extensión de la versión y los listados que nos descargamos para el argumento 3 no trae las extensiones de las versiones.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>En nuestro caso hemos usado “salmon”, que nos genera las counts para cada gen. Hay otros tipos de paquetes que generan abundancia (expresión en TPMs) y para hacer el análisis de expresión diferencial con <code>DESeq2</code> o con <code>edge</code> necesitamos dichas counts. El paquete tximport te permite una estimación de estas counts a partir de la abundacia con el argumento <code>countsFromAbundance</code>.</p>
</div>
</div>
<p>Por último, para guardar el archivo podemos crear un .csv con los datos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(txi.salmon<span class="sc">$</span>counts, <span class="at">file=</span><span class="st">"Basal_vs_Luminal.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="workflow-deseq2" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Workflow DESeq2</h1>
<p>Dejo aquí un link de unos seminarios de la universidad de Harvard en los que está todo super explicado:</p>
<ul>
<li><a href="https://hbctraining.github.io/Intro-to-R-with-DGE/schedule/">Introduction to R and DGE</a></li>
</ul>
<section id="importar-datos" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="importar-datos"><span class="header-section-number">3.1</span> Importar datos</h2>
<p>Una vez que hemos termimado de extraer las counts con salmon en el terminal y hemos generado un <code>.csv</code> con la expresión tenemos que instalar <strong>DESeq2</strong>, que es la herramienta que vamos a utilizar para normalizar y graficar los datos que hemos obtenido.</p>
<p>Primero instalamos todos lo paquetes que vamos a necesitar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"DESeq2"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">#los siguientes paquetes son para representaciones y gestión de datos</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"pheatmap"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"RColorBrewer"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"ashr"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"ggrepel"</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"EnsDb.Hsapiens.v86"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)                </span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"biomaRt"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"PCAtools"</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"magick"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y cargamos las bibliotecas:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DESeq2)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">#los siguientes paquetes son para representaciones de datos</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ashr)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnsDb.Hsapiens.v86)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(biomaRt)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PCAtools)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magick)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ahora podemos cargar los datos que hemos generado el <code>.csv</code>:</p>
<div class="cell-output-display">
<table class="table">
<caption>Basal_vs_Luminal_GC.csv</caption>
<colgroup>
<col style="width: 21%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Basal_1</th>
<th style="text-align: right;">Basal_2</th>
<th style="text-align: right;">Basal_3</th>
<th style="text-align: right;">Luminal_1</th>
<th style="text-align: right;">Luminal_2</th>
<th style="text-align: right;">Luminal_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ENSG00000000003</td>
<td style="text-align: right;">3063.523</td>
<td style="text-align: right;">2595.819</td>
<td style="text-align: right;">1858.888</td>
<td style="text-align: right;">5484.804</td>
<td style="text-align: right;">5835.183</td>
<td style="text-align: right;">5282.971</td>
</tr>
<tr class="even">
<td style="text-align: left;">ENSG00000000005</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">3.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ENSG00000000419</td>
<td style="text-align: right;">5789.018</td>
<td style="text-align: right;">3872.824</td>
<td style="text-align: right;">4193.611</td>
<td style="text-align: right;">4048.758</td>
<td style="text-align: right;">2490.729</td>
<td style="text-align: right;">3660.102</td>
</tr>
<tr class="even">
<td style="text-align: left;">ENSG00000000457</td>
<td style="text-align: right;">2009.020</td>
<td style="text-align: right;">1613.409</td>
<td style="text-align: right;">1420.251</td>
<td style="text-align: right;">3384.663</td>
<td style="text-align: right;">2402.486</td>
<td style="text-align: right;">2763.960</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ENSG00000000460</td>
<td style="text-align: right;">614.459</td>
<td style="text-align: right;">400.559</td>
<td style="text-align: right;">455.363</td>
<td style="text-align: right;">826.121</td>
<td style="text-align: right;">505.659</td>
<td style="text-align: right;">613.572</td>
</tr>
<tr class="even">
<td style="text-align: left;">ENSG00000000938</td>
<td style="text-align: right;">18.000</td>
<td style="text-align: right;">93.000</td>
<td style="text-align: right;">26.000</td>
<td style="text-align: right;">9.000</td>
<td style="text-align: right;">33.000</td>
<td style="text-align: right;">8.000</td>
</tr>
</tbody>
</table>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="Formato de la metadata">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Formato de la metadata
</div>
</div>
<div class="callout-body-container callout-body">
<p>Tenemos que crear un <code>.csv</code> de metada para poder analizar las distintas variables. Este archivo lo podemos crear mediante excel, en el cual en la primera columna tiene que estar el id de las muestras (el nombre que hayamos puesto a la muestra durante el análisis con salmon) y en el resto de columnos vamos metiendo variables de análisis. La primera fila tiene que tener el encabezado de la columna. Tenemos que asegurarnos de guardarlo en <code>.csv</code> y modificarlo desde el editor de texto para que esté verdaderamente separado con comas (ya que al crearlo en excel se nos guardará separado por “;”, en definitiva es hacer lo mismo que cuando queremos cargar algo en metaboanalyst).</p>
</div>
</div>
<p>Ahora podemos cargar el archivo que hemos creado con la metadata de las muestras. Tenemos que convertir en factor todas las variables que lo sean (no he probado con variables continuas):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>metaData <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">read.csv</span>(<span class="st">'Metadata_Basal_vs_Luminal.csv'</span>, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">row.name=</span><span class="dv">1</span>, <span class="at">sep =</span> <span class="st">","</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>metaData[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(metaData))]<span class="ot">&lt;-</span><span class="fu">as.factor</span>(metaData[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(metaData))])</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(metaData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          cell_type
Basal_1       Basal
Basal_2       Basal
Basal_3       Basal
Luminal_1   Luminal
Luminal_2   Luminal
Luminal_3   Luminal</code></pre>
</div>
</div>
<p>Vamos a introducir un paso de checkeo de que los nombres de las columnas de la matriz de datos y los nombre de las filas de matriz de MetaData están en el mismo orden para así estar seguros de que se van a cargar bien en el paquete:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">rownames</span>(metaData) <span class="sc">==</span> <span class="fu">colnames</span>(countData))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>A continuación vamos a crear el dataframe que contendrá el análisis con el siguiente comando:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>dds <span class="ot">&lt;-</span> <span class="fu">DESeqDataSetFromMatrix</span>(<span class="at">countData=</span><span class="fu">round</span>(countData), </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colData=</span>metaData, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design=</span><span class="sc">~</span>cell_type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>converting counts to integer mode</code></pre>
</div>
</div>
<p>Con el argumento countData definimos la variable en la que tenemos guardada la matriz de expresión de cada uno de los genes. Con el argumento colData vamos a definir el archivo en el que tenemos la metadata de las muestras. Con el argumento <code>desing=</code> vamos a definir cómo vamos a crear los grupos de comparación. Para ello tenemos que poner la virgulilla, es decir, “<em>~</em>” seguido del nombre de la columna que contenga la variable diferencial en la que basarse para crear los grupos. Si tuvieramos más grupos de interés para incluir en el análisis (tienen que estar incluidos en el archivo metadata) deberíamos añadirlos como en el siguiente ejemplo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dds <span class="ot">&lt;-</span> <span class="fu">DESeqDataSetFromMatrix</span>(<span class="at">countData=</span><span class="fu">round</span>(countData), </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">colData=</span>metaData, </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">design=</span><span class="sc">~</span>cell_type <span class="sc">+</span> tissue <span class="sc">+</span> sex <span class="sc">+</span> age)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>con este ejemplo, imaginando que pueden ser células de cualquier tejido, la comparación se calculará para tipo de células (cell_type), para el tipo de tejido (tissue), para el sexo del individuo (sex) y para la edad del mismo (age).</p>
</section>
<section id="preprocesamiento-prefiltrado" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="preprocesamiento-prefiltrado"><span class="header-section-number">3.2</span> Preprocesamiento (prefiltrado)</h2>
<p>Si bien no es necesario filtrar previamente los genes de conteo bajo antes de ejecutar las funciones de <strong>DESeq2</strong>, hay dos razones que hacen que el filtrado previo sea útil: al eliminar filas en las que hay muy pocas lecturas, reducimos el tamaño de la memoria del objeto de datos dds, y aumentamos la velocidad del modelado de conteo dentro de <strong>DESeq2</strong>. También puede mejorar las visualizaciones, ya que las características sin información para la expresión diferencial no se trazan en diagramas de dispersión o diagramas MA.</p>
<p>Aquí realizamos un filtrado previo para mantener solo las filas que tienen un recuento de al menos 10 para una cantidad mínima de muestras. El recuento de 10 es una opción razonable para la secuenciación de ARN masiva. Una recomendación para el número mínimo de muestras es especificar el tamaño de grupo más pequeño; por ejemplo, aquí hay 3 muestras tratadas. Si no hay grupos discretos, se puede utilizar el número mínimo de muestras donde los recuentos distintos de cero se considerarían interesantes. También se puede omitir este paso por completo y simplemente confiar en los procedimientos de filtrado independientes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>smallestGroupSize <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">counts</span>(dds) <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">&gt;=</span> smallestGroupSize</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>dds <span class="ot">&lt;-</span> dds[keep,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A continuación es importante establecer cuál va a ser el grupo de control de los que tenemos (en nuestro caso van a ser las células basales):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>dds<span class="sc">$</span>condition<span class="ot">&lt;-</span><span class="fu">relevel</span>(dds<span class="sc">$</span>cell_type, <span class="at">ref=</span><span class="st">"Basal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El análisis de expresión diferencial propiamente dicho lo hacemos con la función <code>DESeq()</code>, y ya calcula muchas cosas (de forma automática) de las que vamos a ir viendo ahora. Pero para mejorar el entendimiento del trabajo con los datos no vamos a adelantar aconteciminetos, así que por ahora no lo vamos a usar y vamos a ver como se normalizan estos datos.</p>
<p>La función <code>DESeq()</code> realiza de forma automática los siguientes análisis:</p>
<ol type="1">
<li>Estimar los “size factors” (el peso que tiene en la dispersión de los valores de cada muestra la variable que estamos utilizando para la comparación)</li>
<li>Estimar la dispersión génica (como aumenta la variabilidad en función del número de transcritos, esto es intrínseco a la metodología de manera que hay que corregirlo)</li>
<li>Corregir la dispersión génica (se realiza con estimaciones con respecto al modelo al que debería ajustarse la disperisón de los datos, pero como toda estimación, necesita ser corregiva para evitar sobreestimaciones, es decir, falsos positivos)</li>
<li>Reducción de las estimaciones de la dispersión por la corrección</li>
</ol>
</section>
<section id="análisis-de-calidad-de-las-muestras-qc-analyses" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="análisis-de-calidad-de-las-muestras-qc-analyses"><span class="header-section-number">3.3</span> Análisis de calidad de las muestras (QC Analyses)</h2>
<p>Los siguientes pasos son la normalización y análisis no supervisado de las muestras para evaluar la calidad de las mismas.</p>
<section id="normalización" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="normalización"><span class="header-section-number">3.3.1</span> Normalización</h3>
<p>Vamos a seguir los pasos del workshop de Harvard que encontré (que está genial), en este caso vamos a usar el archivo <a href="https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html">Introduction to DGE</a> donde está super bien explicado a nivel teórico (con esquemas y todo). Si queremos mayor profundidad a nivel matemáticod beremos acceder a la vignette de <a href="https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html">DESeq2</a>. El primer paso de todo análisis de expresión diferencial es una normalización de los counts para que la comparación entre muestras sea más certera y fiable. Los pricipales factores que se deben de considerar para la normalización son:</p>
<ul>
<li>Profuncidad de la secuenciación</li>
<li>Longitud del gen</li>
<li>Composición del RNA</li>
</ul>
<p>Estos términos están perfectamente explicados en <a href="https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html">Introduction to DGE</a>, además incluye una tabla con los métodos de normalización para RNAseq con ventajas y desventajas.</p>
<p><strong>DESeq2</strong> utiliza un método de normalización de las counts dividads por factores de tamaño específicos de la muestra determinados por la relación mediana de los recuentos de genes en relación con la media geométrica por gen. Esta normalización hace que sea <strong>muy potente para la el análsis de expresión diderencial, pero no lo podemos utilizar para una comparación entre genes de una misma muestra</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>(para eso deberíamos utilizar la expresión normalizada por TPM, es decir, utilizar la matriz de <code>tximpor</code> recupenrando los datos de la columna de “abundancia”)</em>. Perfectamente explicado, de nuevo, en <a href="https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html">Introduction to DGE</a>.</p>
</div>
</div>
<p>Para acceder a los <code>size factors</code> <em>si hubieramos utilizado la función <code>DESeq()</code></em> podriamos utilizar la función <code>sizeFactors</code> directamente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#hacemos el análisis y lo definimos en la varibale dds_DEs</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>dds_DEs<span class="ot">&lt;-</span><span class="fu">DESeq</span>(dds)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">#y ahora extraeríamos los datos</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sizeFactors</span>(dds_DEs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pero como todavía <strong>NO</strong> hemos utilizado todavía la función <code>DEseq()</code> y queremos averiguar los “size factors” de nuestra matriz, primero temnemos que usar la función <code>estimateSizeFactors()</code> para calcular dichos factores e incluirlos en el data frame <code>dds</code>. El código sería el siguiente:*</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculamos los factores y lo metemos en la variable dds</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>dds <span class="ot">&lt;-</span> <span class="fu">estimateSizeFactors</span>(dds)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co">#y ahora podríamos acceder a esos datos</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sizeFactors</span>(dds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Basal_1   Basal_2   Basal_3 Luminal_1 Luminal_2 Luminal_3 
1.1167981 1.0037478 0.9737041 1.0030643 0.9418799 0.9892795 </code></pre>
</div>
</div>
<p>Ahora podríamos extraer los datos normalizados (con la función <code>counts()</code> en una matriz de datos distinta para así poder trabajar con ellos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>normalized_counts<span class="ot">&lt;-</span><span class="fu">counts</span>(dds, <span class="at">normalized=</span><span class="cn">TRUE</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(normalized_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   Basal_1    Basal_2    Basal_3   Luminal_1  Luminal_2
ENSG00000000003 2743.55778 2586.30696 1909.20427 5468.243490 6195.05740
ENSG00000000419 5183.56918 3858.53884 4307.26343 4036.630427 2644.71088
ENSG00000000457 1798.89281 1606.97732 1458.34861 3374.658927 2550.21900
ENSG00000000460  549.78606  399.50273  467.28776  823.476595  537.22349
ENSG00000000938   16.11751   92.65275   26.70216    8.972505   35.03631
ENSG00000000971 4315.91008 3637.36776 2018.06691 6813.122335 3766.93464
                  Luminal_3
ENSG00000000003 5340.250419
ENSG00000000419 3699.662414
ENSG00000000457 2793.952709
ENSG00000000460  620.653749
ENSG00000000938    8.086694
ENSG00000000971 2155.103898</code></pre>
</div>
</div>
<p>Vamos a extraer estos datos normalizados en un archivo para utilizarlos más adelante:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(normalized_counts, <span class="at">file=</span><span class="st">"/normalized_counts.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>DESeq2 no utiliza realmente counts normalizadas, sino que utiliza los counts brutos y modela la normalización dentro del Modelo Lineal Generalizado (GLM). Estos recuentos normalizados serán útiles para la visualización posterior de los resultados, pero no se pueden utilizar como entrada para DESeq2 o cualquier otra herramienta que realice análisis de expresión diferencial que utilice el modelo binomial negativo.</p>
</div>
</div>
</section>
<section id="análisis-de-clustering-no-supervisado" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="análisis-de-clustering-no-supervisado"><span class="header-section-number">3.3.2</span> Análisis de clustering no supervisado</h3>
<p>Para realizar el análisis de calidad de las muestras necesitamos la matriz de datos normalizados. <strong>DESeq</strong> incluye una función propia de normalización de datos muy robusta y aceptada por la comunidad, que si quereis saber cómo funciona podeis ir a la vignette de <a href="https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html">DESeq2</a> o a la página que os recomendé al principio que explica todo el workflow, es este caso a la sección de <a href="https://hbctraining.github.io/DGE_workshop/lessons/03_DGE_QC_analysis.html">“QC Analysis”</a> y leerlo: En mi caso he usado una combinación de ambas cosas para evaluar más parámetros. Para ejecutarla:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>rld <span class="ot">&lt;-</span> <span class="fu">rlog</span>(dds, <span class="at">blind=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El argumento <code>blind=</code> es para saber si la transformación debe ser ciega a la información de la muestra especificada por la fórmula de diseño. Cuando ciego es igual a <code>TRUE</code> (por defecto), las funciones reestimarán las dispersiones utilizando sólo un intercepto. Este argumento debería utilizarse para comparar muestras de una manera totalmente insesgada por la información sobre los grupos experimentales, por ejemplo para realizar el aseguramiento de la calidad de la muestra, como se demuestra a continuación.</p>
<p>Sin embargo, la estimación de la dispersión ciega no es la opción adecuada si se espera que muchos o la mayoría de los genes (filas) tengan grandes diferencias en los recuentos que puedan explicarse por el diseño experimental, y se desea transformar los datos para un análisis posterior. En este caso, el uso de la estimación ciega de la dispersión dará lugar a grandes estimaciones de la dispersión, ya que atribuye las diferencias debidas al diseño experimental como ruido no deseado, y dará lugar a una reducción excesiva de los valores transformados entre sí. Estableciendo ciego a <code>FALSE</code>, las dispersiones ya estimadas se utilizarán para realizar las transformaciones, o si no están presentes, se estimarán utilizando la fórmula de diseño actual. Tenga en cuenta que en la transformación sólo se utilizan las estimaciones de dispersión ajustadas de la línea de tendencia media-dispersión (la dependencia global de la dispersión respecto a la media para todo el experimento). Por lo tanto, establecer ciego a <code>FALSE</code> sigue siendo, en su mayor parte, no utilizar la información sobre qué muestras estaban en qué grupo experimental en la aplicación de la transformación.</p>
<p>En resumen, que seleccionemos <code>FALSE</code>.</p>
<p>NOTA: La función <code>rlog()</code> puede ser un poco lenta cuando se tienen, por ejemplo, &gt; 20 muestras. En estas situaciones, la función <code>vst()</code> es mucho más rápida y realiza una transformación similar apropiada para su uso para análisis de calidad.</p>
<section id="barplot" class="level4" data-number="3.3.2.1">
<h4 data-number="3.3.2.1" class="anchored" data-anchor-id="barplot"><span class="header-section-number">3.3.2.1</span> Barplot</h4>
<p>Con estas gráficas vamos a mostrar el nº de counts totales para cada muestra para asegurarnos de que no están muy dispares, por lo que se utilizan los datos importados del <code>.csv</code> previos a la normalización (ya que solo queremos counts). para ello tenemso que trasformar los datos a dos columnas (<em>x</em>, el cual va a ser el nombre de la muestra, e <em>y</em>, que va a ser el valor de la suma de los counts de cada muestra) que son las que utilizaremos para realizar el gráfico:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Para llevar a cabo esta parte tenemos que instalar y cargar el paquete tidyverse</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>sum_CD<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(normalized_counts) <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(columname, values) <span class="sc">%&gt;%</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(columname) <span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Count_sum=</span><span class="fu">sum</span>(values))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sum_CD, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(columname), <span class="at">y=</span>Count_sum))<span class="sc">+</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>)<span class="sc">+</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Total number of counts"</span>)<span class="sc">+</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Muestras"</span>)<span class="sc">+</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Normalized counts"</span>)<span class="sc">+</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>)<span class="sc">+</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">round</span>(Count_sum)), <span class="at">color=</span><span class="st">"white"</span>, <span class="at">vjust=</span><span class="fl">1.6</span>, <span class="at">size=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Una alternativa (simplemente para ver el explorar el uso de <code>ggplot()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>sum_CD<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(normalized_counts) <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(columname, values) <span class="sc">%&gt;%</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(columname) <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">Count_sum=</span><span class="fu">sum</span>(values))</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">#tenemos que tranformar los datos para que sea interpretable por ggplot</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sum_CD, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(columname), <span class="at">y=</span>Count_sum, <span class="at">fill=</span>Count_sum))<span class="sc">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_gradientn</span>(<span class="at">colors=</span>pals<span class="sc">::</span><span class="fu">brewer.greens</span>(<span class="dv">15</span>),</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>                           <span class="at">lim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(sum_CD<span class="sc">$</span>Count_sum)))<span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ggtitle</span>(<span class="st">"Total number of counts"</span>)<span class="sc">+</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlab</span>(<span class="st">"Muestras"</span>)<span class="sc">+</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ylab</span>(<span class="st">"Raw counts"</span>)<span class="sc">+</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>)<span class="sc">+</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">round</span>(Count_sum)), <span class="at">color=</span><span class="st">"white"</span>, <span class="at">vjust=</span><span class="fl">1.6</span>, <span class="at">size=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Si quisieramos guardar la anterior gráfica como un documento tendremos que usar la función <code>ggsave()</code>, guardando la gráfica en una variable <code>barplotcounts</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>barplotcounts<span class="ot">&lt;-</span><span class="fu">ggplot</span>(sum_CD, <span class="fu">aes</span>(<span class="at">x=</span><span class="fu">as.factor</span>(columname), <span class="at">y=</span>Count_sum, <span class="at">fill=</span>Count_sum))<span class="sc">+</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat=</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">scale_fill_gradientn</span>(<span class="at">colors=</span>pals<span class="sc">::</span><span class="fu">brewer.greens</span>(<span class="dv">15</span>),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">lim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fu">max</span>(sum_CD<span class="sc">$</span>Count_sum)))<span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ggtitle</span>(<span class="st">"Total number of counts"</span>)<span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">xlab</span>(<span class="st">"Muestras"</span>)<span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ylab</span>(<span class="st">"Raw counts"</span>)<span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"right"</span>)<span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label=</span><span class="fu">round</span>(Count_sum)), <span class="at">color=</span><span class="st">"white"</span>, <span class="at">vjust=</span><span class="fl">1.6</span>, <span class="at">size=</span><span class="dv">3</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(barplotcounts,<span class="at">filename=</span><span class="st">"barplotcounts.pdf"</span>, <span class="at">device=</span>pdf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="boxplot" class="level4" data-number="3.3.2.2">
<h4 data-number="3.3.2.2" class="anchored" data-anchor-id="boxplot"><span class="header-section-number">3.3.2.2</span> boxplot</h4>
<p>Tambien podemos hacer un boxplot de los counts de las muestras normalizadas con (log10(count)+1) y ver la distribución. Esto lo podemos hacer con la función boxplot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">boxplot</span>(<span class="fu">log10</span>(normalized_counts)<span class="sc">+</span><span class="dv">1</span>,</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">main=</span><span class="st">"Boxplot"</span>, <span class="at">xlab=</span><span class="st">"Muestras"</span>, <span class="at">ylab=</span><span class="st">"Normalized counts Log10(Counts)+1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>O con <code>ggplot()</code>, Pero para hacerlo con ggplot primero necesitamos crear una matriz interpretable por ggplot para generar el gráfico. Para ello vamos a usar el paquete <code>tidyvese()</code>, que generará una matriz de datos que podremos utilizar (transformación a matriz larga):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co">#definimos la normalización para la representación como una variable independiente para trabajar de forma más sencilla.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>normcounts<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(<span class="fu">log10</span>(normalized_counts)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co">#a continuación creamos la matriz larga</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>long_df<span class="ot">&lt;-</span>normcounts <span class="sc">%&gt;%</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">"rowname"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(columname, value, <span class="sc">-</span>rowname)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co">#definimos el nombre de las columnas</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(long_df)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Ensembl_ID"</span>, <span class="st">"Samples"</span>, <span class="st">"Expression"</span>)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a><span class="co">#también tenemos que definir las muestras como un factor para que boxplot funcione bien</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>long_df<span class="sc">$</span>Samples<span class="ot">&lt;-</span><span class="fu">as.factor</span>(long_df<span class="sc">$</span>Samples)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co">#ahora graficamos con ggplot</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(long_df, <span class="fu">aes</span>(<span class="at">x=</span>Samples, <span class="at">y=</span>Expression)) <span class="sc">+</span> <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Boxpot"</span>) <span class="sc">+</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Samples"</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">"Normalized expression </span><span class="sc">\n</span><span class="st"> log(counts)+1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Con ggplot es mucho más manejable el hacer gráficos.</p>
</section>
<section id="pca-plot" class="level4" data-number="3.3.2.3">
<h4 data-number="3.3.2.3" class="anchored" data-anchor-id="pca-plot"><span class="header-section-number">3.3.2.3</span> PCA plot</h4>
<p><strong>DESe2</strong> utiliza el paquete <code>ggplot2</code> para generar gráficos. Para poder hacer el gráfico por defecto necesitamos los datos normalizados (lo que hemos hecho con la función <code>rlog()</code>). Por defecto podemos hacer una gráfica sencilla:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotPCA</span>(rld, <span class="at">intgroup=</span><span class="st">"cell_type"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>También podemos customizar la gráfica con funciones del paquete <code>ggplot2</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>pcaData <span class="ot">&lt;-</span> <span class="fu">plotPCA</span>(rld, <span class="at">intgroup=</span><span class="fu">c</span>(<span class="st">"cell_type"</span>, <span class="st">"cell_type"</span>), <span class="at">returnData=</span><span class="cn">TRUE</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>percentVar <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="dv">100</span> <span class="sc">*</span> <span class="fu">attr</span>(pcaData, <span class="st">"percentVar"</span>))</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pcaData, <span class="fu">aes</span>(PC1, PC2, <span class="at">color=</span>cell_type, <span class="at">shape=</span>cell_type)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"PCA plot of example </span><span class="sc">\n</span><span class="st"> RNAseq"</span>)<span class="sc">+</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="fu">paste0</span>(<span class="st">"PC1 ("</span>,percentVar[<span class="dv">1</span>],<span class="st">"%)"</span>)) <span class="sc">+</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">paste0</span>(<span class="st">"PC2 ("</span>,percentVar[<span class="dv">2</span>],<span class="st">"%)"</span>)) <span class="sc">+</span> </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-54-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="heatmap" class="level4" data-number="3.3.2.4">
<h4 data-number="3.3.2.4" class="anchored" data-anchor-id="heatmap"><span class="header-section-number">3.3.2.4</span> Heatmap</h4>
<p>También es común utilizar un heatmap para la visualización de la calidad de las muestras para ver como clusterizan:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#para utilizar esta función hemos tenido que instalar y cargar el paquete pheatmap</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>select<span class="ot">&lt;-</span><span class="fu">order</span>(<span class="fu">rowMeans</span>(normalized_counts),<span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">25</span>]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> metaData</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">assay</span>(rld)[select,], <span class="at">cluster_rows=</span><span class="cn">FALSE</span>, <span class="at">show_rownames=</span><span class="cn">FALSE</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster_cols=</span><span class="cn">TRUE</span>, <span class="at">annotation_col=</span>df, <span class="at">main=</span><span class="st">"Heatmap plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Si tuvieramos mayor cantidad de datos clínicos o variables en metadata podríamos añadirlos de la siguiente manera (yo voy a repetir el mismo tipo de datos dos veces):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#voy a crear una nueva metadata que tenga dos veces la misma columna de cell_type para mostrar el ejemplo</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>metaData_ejm <span class="ot">&lt;-</span> metaData</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>metaData_ejm[,<span class="dv">2</span>]<span class="ot">&lt;-</span> metaData[, <span class="dv">1</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(metaData_ejm)[<span class="dv">2</span>]<span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"variable imaginaria"</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">#y ahora haríamos el heatmap</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>select<span class="ot">&lt;-</span><span class="fu">order</span>(<span class="fu">rowMeans</span>(normalized_counts),<span class="at">decreasing=</span><span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>]</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">#en el df tenemos que meter las variables de nuestra metaData que queramos ver</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> metaData_ejm[,<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)]</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(<span class="fu">assay</span>(rld)[select,], <span class="at">cluster_rows=</span><span class="cn">FALSE</span>, <span class="at">show_rownames=</span><span class="cn">FALSE</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster_cols=</span><span class="cn">FALSE</span>, <span class="at">annotation_col=</span>df, <span class="at">main=</span><span class="st">"Heatmap plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-56-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Hay muchas posibilidades, buscad el paquete en google y consultais los argumentos para manipular los datos al gusto.</p>
</section>
<section id="distancia-entre-muestras" class="level4" data-number="3.3.2.5">
<h4 data-number="3.3.2.5" class="anchored" data-anchor-id="distancia-entre-muestras"><span class="header-section-number">3.3.2.5</span> Distancia entre muestras</h4>
<p>Otro uso de los datos transformados es la agrupación de muestras. En este caso, aplicamos la función <code>dist()</code> a la transposición de la matriz de recuento transformada para obtener distancia muestra-muestra:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>sampleDists <span class="ot">&lt;-</span> <span class="fu">dist</span>(<span class="fu">t</span>(<span class="fu">assay</span>(rld)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A continuación, si solo tenemos las muestras con una condición queremos enfrentar las muestras contra ellas mismas de manera que haríamos lo siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>sampleDistMatrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(sampleDists)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sampleDistMatrix) <span class="ot">&lt;-</span> rld<span class="sc">@</span>colData<span class="sc">@</span>rownames</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sampleDistMatrix) <span class="ot">&lt;-</span> rld<span class="sc">@</span>colData<span class="sc">@</span>rownames</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>( <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">"Blues"</span>)) )(<span class="dv">255</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(sampleDistMatrix,</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_rows=</span>sampleDists,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_cols=</span>sampleDists,</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">col=</span>colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Si tuvieramos dos o más condiciones descriptivas (en mi caso voy a repetir dos veces el tipo celular para que se pueda ver cómo se usaría el código para emparejar variables para la comparación):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Para estos colores hemos tenido que instalar y cargar el paquete "RColorBrewer"</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>sampleDistMatrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(sampleDists)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sampleDistMatrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(rld<span class="sc">$</span>cell_type, rld<span class="sc">$</span>cell_type, <span class="at">sep=</span><span class="st">"-"</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sampleDistMatrix) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>colors <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>( <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">9</span>, <span class="st">"Blues"</span>)) )(<span class="dv">255</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(sampleDistMatrix,</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_rows=</span>sampleDists,</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">clustering_distance_cols=</span>sampleDists,</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">col=</span>colors)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>En el heatmap podemos ver las distancias, lo que nos da una overview sobre similaridades y diferencias entre muestras.</p>
</section>
</section>
</section>
<section id="análisis-de-expresión-diferencial-de-analysis" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="análisis-de-expresión-diferencial-de-analysis"><span class="header-section-number">3.4</span> Análisis de Expresión diferencial (DE analysis)</h2>
<p>Brevemente, <strong>DESeq2</strong> modelará los recuentos brutos, utilizando factores de normalización (factores de tamaño) para tener en cuenta las diferencias en la profundidad de las bibliotecas. A continuación, estimará las dispersiones por genes y reducirá estas estimaciones para generar estimaciones más precisas de la dispersión para modelar los recuentos. Por último, DESeq2 ajustará el modelo binomial negativo y realizará pruebas de hipótesis utilizando el test de Wald o Likelihood Ratio Test (prueba de razón de verosimilitud).</p>
<p>La función <code>DESeq()</code> realiza de forma automática los siguientes análisis:</p>
<ol type="1">
<li>Estimar los “size factors” (el peso que tiene en la dispersión de los valores de cada muestra la variable que estamos utilizando para la comparación)</li>
<li>Estimar la dispersión génica (como aumenta la variabilidad en función del número de transcritos, esto es intrínseco a la metodología de manera que hay que corregirlo)</li>
<li>Corregir la dispersión génica (se realiza con estimaciones con respecto al modelo al que debería ajustarse la disperisón de los datos, pero como toda estimación, necesita ser corregiva para evitar sobreestimaciones, es decir, falsos positivos)</li>
<li>Reducción de las estimaciones de la dispersión por la corrección</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>dds_DEs<span class="ot">&lt;-</span><span class="fu">DESeq</span>(dds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>using pre-existing size factors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>estimating dispersions</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>gene-wise dispersion estimates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>mean-dispersion relationship</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>final dispersion estimates</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>fitting model and testing</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dds_DEs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class: DESeqDataSet 
dim: 6 6 
metadata(1): version
assays(4): counts mu H cooks
rownames(6): ENSG00000000003 ENSG00000000419 ... ENSG00000000938
  ENSG00000000971
rowData names(22): baseMean baseVar ... deviance maxCooks
colnames(6): Basal_1 Basal_2 ... Luminal_2 Luminal_3
colData names(3): cell_type condition sizeFactor</code></pre>
</div>
</div>
<section id="modelado-de-las-counts-para-cada-gen-y-fold-changes-corregidos" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="modelado-de-las-counts-para-cada-gen-y-fold-changes-corregidos"><span class="header-section-number">3.4.1</span> Modelado de las counts para cada gen y Fold changes corregidos</h3>
<section id="generación-de-un-modelo-linaear-de-ajuste-para-cada-gen" class="level4" data-number="3.4.1.1">
<h4 data-number="3.4.1.1" class="anchored" data-anchor-id="generación-de-un-modelo-linaear-de-ajuste-para-cada-gen"><span class="header-section-number">3.4.1.1</span> Generación de un modelo linaear de ajuste para cada gen</h4>
<p>El último paso del flujo de trabajo de <strong>DESeq2</strong> es ajustar el modelo binomial negativo para cada gen y realizar pruebas de expresión diferencial.</p>
<p>Como se ha comentado anteriormente, los datos de recuento generados por RNA-seq presentan sobredispersión (varianza &gt; media) y la distribución estadística utilizada para modelar las “counts” debe tener en cuenta esta sobredispersión. DESeq2 utiliza una distribución binomial negativa para modelar los recuentos de RNA-seq.</p>
<p>El modelado es una forma matemática de aproximar cómo se comportan los datos dado un conjunto de parámetros (es decir, factor de tamaño, dispersión). <strong>DESeq2</strong> utilizará esta fórmula como modelo para cada gen y ajustará a ella los datos de “counts” normalizados. Una vez ajustado el modelo, se estiman los coeficientes para cada grupo de muestras junto con su error estándar.</p>
<p>Los coeficientes son las estimaciones de los cambios de log2 para cada grupo de muestras. Sin embargo, estas estimaciones no tienen en cuenta la gran dispersión que observamos en los recuentos bajos de lecturas. Para evitarlo, es necesario ajustar los cambios de pliegue log2 calculados por el modelo.</p>
</section>
<section id="shrunken-log2-foldchanges-lfc" class="level4" data-number="3.4.1.2">
<h4 data-number="3.4.1.2" class="anchored" data-anchor-id="shrunken-log2-foldchanges-lfc"><span class="header-section-number">3.4.1.2</span> Shrunken Log2 Foldchanges (LFC)</h4>
<p>Para generar una estimación más precisa de log2 Fold Change (LFC), <strong>DESeq2</strong> permite la reducción de las estimaciones LFC hacia cero cuando la información de un gen es baja:</p>
<ul>
<li>Pocas counts</li>
<li>Elevados valores de dispersión</li>
</ul>
<p>Al igual que con la reducción de las estimaciones de dispersión, la reducción de LFC utiliza información de todos los genes para generar estimaciones más precisas. En concreto, la distribución de las estimaciones de LFC para todos los genes se utiliza (como un prior) para encoger las estimaciones de LFC de los genes con poca información o alta dispersión hacia estimaciones de LFC más probables (más bajas).</p>
<p>Para generar esta estimación del LFC, hay que correr la función adicional (<code>lfcSrink()</code>).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>La reducción de los cambios de pliegues log2 no cambiará el número total de genes que se identifican como significativamente expresados de forma diferencial. La reducción del cambio de pliegue es para ayudar con la evaluación posterior de los resultados. Por ejemplo, si desea subconjuntar sus genes significativos basándose en el cambio de pliegue para una evaluación posterior, puede que desee utilizar los valores shruken. Además, para las herramientas de análisis funcional como GSEA que requieren valores de cambio de pliegue como entrada, usted querría proporcionar valores reducidos.</p>
</div>
</div>
</section>
</section>
<section id="evaluación-de-la-expresión-diferencial" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="evaluación-de-la-expresión-diferencial"><span class="header-section-number">3.4.2</span> Evaluación de la expresión diferencial</h3>
<p>El primer paso en la prueba de hipótesis es establecer una hipótesis nula para cada gen. En nuestro caso, la hipótesis nula es que no hay expresión diferencial en los dos grupos de muestras (LFC == 0). En segundo lugar, utilizamos una prueba estadística para determinar si, basándonos en los datos observados, la hipótesis nula es cierta.</p>
<p>Con <strong>DESeq2</strong>, el Test de Wald se utiliza habitualmente para la comprobación de hipótesis cuando se comparan dos grupos. Se calcula un estadístico de Test de Wald junto con una probabilidad (p-valor) de que se seleccionara al azar un estadístico de prueba al menos tan extremo como el valor observado. Si el valor p es pequeño, rechazamos la hipótesis nula y afirmamos que existen pruebas en contra de la nula (es decir, que el gen se expresa de forma diferencial).</p>
<section id="crear-los-grupos-de-comparación" class="level4" data-number="3.4.2.1">
<h4 data-number="3.4.2.1" class="anchored" data-anchor-id="crear-los-grupos-de-comparación"><span class="header-section-number">3.4.2.1</span> Crear los grupos de comparación</h4>
<p>Para indicar a DESeq2 qué dos grupos queremos comaprar, usamos la función <code>contrasts()</code>, la está integrada en <strong>DESeq2</strong> para realizar este Test de Wald entre dos grupos de comparación. Las variables a comparar se pueden dar en <strong>DESeq</strong> de dos formas distintas:</p>
<ol type="1">
<li><p>No haciendo nada. Por defecto, <strong>DESeq2</strong> utiliza el factor base de la condición de interés. El factor base de la condición de interés lo selecciona de forma alfabética.</p></li>
<li><p>Con la función <code>results()</code> podemos definir la comparación de interés. El factor dado en último lugar se definirá como el factor base de la comparación. Para asegurarnos de tener nuestra comparación de interés usaremos esta opción. La sintaxis sería la siguiente:</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Definimos la condición a evaluar, el factor a comparar y el factor base (en ese orden), en una variable</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>contrast<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"cell_type"</span>, <span class="st">"Luminal"</span>,<span class="st">"Basal"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Ahora generamos los resultados y la guardamos en una variable nueva para utilzarlos luego</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>res<span class="ot">&lt;-</span><span class="fu">results</span>(dds_DEs, <span class="at">contrast =</span> contrast, <span class="at">alpha =</span> <span class="fl">0.05</span>)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Visualizamos res:</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MLE): cell_type Luminal vs Basal 
Wald test p-value: cell type Luminal vs Basal 
DataFrame with 6 rows and 6 columns
                 baseMean log2FoldChange     lfcSE      stat      pvalue
                &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;
ENSG00000000003 4040.4367       1.231831  0.219235  5.618779 1.92312e-08
ENSG00000000419 3955.0625      -0.362824  0.254226 -1.427170 1.53531e-01
ENSG00000000457 2263.8416       0.841835  0.204578  4.114984 3.87207e-05
ENSG00000000460  566.3217       0.483936  0.274408  1.763562 7.78057e-02
ENSG00000000938   31.2613      -1.380236  0.972290 -1.419572 1.55732e-01
ENSG00000000971 3784.4176       0.352932  0.488092  0.723085 4.69627e-01
                       padj
                  &lt;numeric&gt;
ENSG00000000003 5.89919e-07
ENSG00000000419 3.41626e-01
ENSG00000000457 4.48258e-04
ENSG00000000460 2.12177e-01
ENSG00000000938 3.44979e-01
ENSG00000000971 7.05029e-01</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>El Test de Wald tambien puede utilizar variables contínuas. Si la variable de interés dada en el diseño (con el argumento <code>desing</code> cuando realizamos el <code>DESeqDataSetFromMatrix</code>) es contínua, el report del LFC se realizará por unidad de cambio en esa variable</p>
</div>
</div>
</section>
<section id="contracción-de-la-tabla-de-resultados" class="level4" data-number="3.4.2.2">
<h4 data-number="3.4.2.2" class="anchored" data-anchor-id="contracción-de-la-tabla-de-resultados"><span class="header-section-number">3.4.2.2</span> Contracción de la tabla de resultados</h4>
<p>Para construir nuestra tabla de resultados utilizaremos la función <code>results()</code>. Para indicar a DESeq2 los grupos que deseamos comparar, introduciremos los contrastes que deseamos realizar mediante el argumento <code>contrast</code>. Para este ejemplo, guardaremos las versiones no reducidas y reducidas de los resultados en variables separadas. Además, incluimos el argumento <code>alfa</code> y lo establecemos en 0,05. Este es el límite de significación utilizado para el análisis de la varianza. Este es el límite de significación utilizado para optimizar el filtrado independiente (por defecto se establece en 0,1). Si el valor de corte p ajustado (FDR) será un valor distinto de 0,1 (para nuestra lista final de genes significativos), <code>alfa</code> debe fijarse en ese valor (<code>alfa = 0.05</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">#puede ser que necesitemos instalar el paquete "ashr" desde Bioconductor</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos la tabla de resultados</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>res_table <span class="ot">&lt;-</span> <span class="fu">lfcShrink</span>(dds_DEs, <span class="at">contrast=</span>contrast, <span class="at">res=</span>res, <span class="at">type=</span><span class="st">"ashr"</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co">#visualizamos la tabla de resultados</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log2 fold change (MMSE): cell_type Luminal vs Basal 
Wald test p-value: cell type Luminal vs Basal 
DataFrame with 6 rows and 5 columns
                 baseMean log2FoldChange     lfcSE      pvalue        padj
                &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
ENSG00000000003 4040.4367       1.127634  0.228829 1.92312e-08 5.89919e-07
ENSG00000000419 3955.0625      -0.254933  0.222360 1.53531e-01 3.41626e-01
ENSG00000000457 2263.8416       0.734814  0.205440 3.87207e-05 4.48258e-04
ENSG00000000460  566.3217       0.336907  0.244572 7.78057e-02 2.12177e-01
ENSG00000000938   31.2613      -0.376240  0.601387 1.55732e-01 3.44979e-01
ENSG00000000971 3784.4176       0.157092  0.334196 4.69627e-01 7.05029e-01</code></pre>
</div>
</div>
</section>
<section id="por-qué-usar-el-p-valor-ajustado-en-vez-del-p-valor" class="level4" data-number="3.4.2.3">
<h4 data-number="3.4.2.3" class="anchored" data-anchor-id="por-qué-usar-el-p-valor-ajustado-en-vez-del-p-valor"><span class="header-section-number">3.4.2.3</span> ¿Por qué usar el p-valor ajustado en vez del p-valor?</h4>
<p>En <code>results()</code> tenemos p valores y p valores ajustados. ¿Cuál deberíamos utilizar para identificar los genes expresados de forma significativamente diferente?</p>
<p>Si utilizamos el p valor directamente de la prueba de Wald con un corte de significación de p &lt; 0,05, significa que hay un 5% de posibilidades de que sea un falso positivo. Cada valor p es el resultado de una sola prueba (un solo gen). Cuantos más genes probemos, más inflamos la tasa de falsos positivos. Este es el problema de las pruebas múltiples. Por ejemplo, si probamos 20.000 genes en busca de expresión diferencial, a p &lt; 0,05 esperaríamos encontrar 1.000 genes por azar. Si encontramos un total de 3.000 genes con expresión diferencial, aproximadamente un tercio de nuestros genes son falsos positivos. No querríamos cribar nuestros genes “significativos” para identificar cuáles son los verdaderos positivos.</p>
<p>DESeq2 ayuda a reducir el número de genes analizados mediante la eliminación de aquellos genes con pocas probabilidades de ser significativamente DE antes de la prueba, como aquellos con bajo número de recuentos y muestras atípicas (QC a nivel de genes). Sin embargo, aún necesitamos corregir las pruebas múltiples para reducir el número de falsos positivos, y existen algunos enfoques comunes:</p>
<ul>
<li><p><strong>Bonferroni</strong>: The adjusted p-value is calculated by: p-value * m (m = total number of tests). This is a very conservative approach with a high probability of false negatives, so is generally not recommended.</p></li>
<li><p><strong>FDR/Benjamini-Hochberg</strong>: Benjamini and Hochberg (1995) defined the concept of FDR and created an algorithm to control the expected FDR below a specified level given a list of independent p-values. An interpretation of the BH method for controlling the FDR is implemented in DESeq2 in which we rank the genes by p-value, then multiply each ranked p-value by m/rank.</p></li>
<li><p><strong>Q-value / Storey method</strong>: The minimum FDR that can be attained when calling that feature significant. For example, if gene X has a q-value of 0.013 it means that 1.3% of genes that show p-values at least as small as gene X are false positives</p></li>
</ul>
<p>En <strong>DESeq2</strong>, los p valores obtenidos mediante la prueba de Wald se corrigen por defecto para pruebas múltiples utilizando el método de Benjamini y Hochberg. Existen opciones para utilizar otros métodos en la función <code>results()</code>. Los p valores ajustados deben utilizarse para determinar los genes significativos. Los genes significativos pueden mostrarse para su visualización y/o análisis funcional.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Entonces, ¿qué significa FDR &lt; 0.05?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Al establecer el límite FDR en &lt; 0,05, estamos diciendo que la proporción de falsos positivos que esperamos entre nuestros genes expresados diferencialmente es del 5%. Por ejemplo, si llama a 500 genes como expresados diferencialmente con un corte FDR de 0,05, espera que 25 de ellos sean falsos positivos.</p>
</div>
</div>
</div>
</section>
<section id="ma-plot" class="level4" data-number="3.4.2.4">
<h4 data-number="3.4.2.4" class="anchored" data-anchor-id="ma-plot"><span class="header-section-number">3.4.2.4</span> MA plot</h4>
<p>El gráfico MA muestra la media de los recuentos normalizados frente a los cambios de pliegues log2 para todos los genes analizados. Los genes que son significativamente DE están coloreados para ser fácilmente identificados. Esta es también una buena manera de ilustrar el efecto de la contracción de LFC. El paquete DESeq2 ofrece una función sencilla para generar un gráfico MA.</p>
<p>Para ver de forma visual en lo que consiste el ajuste de estimación que hemos hecho en el paso anterior vamos a hacer el MA plot (con la función <code>plotMA()</code>) con los datos sin corregir:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotMA</span>(res, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y ahora tras ejecutar el ajuste de estimación:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotMA</span>(res_table, <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="extracción-de-los-genes-diferencialmente-expresados" class="level4" data-number="3.4.2.5">
<h4 data-number="3.4.2.5" class="anchored" data-anchor-id="extracción-de-los-genes-diferencialmente-expresados"><span class="header-section-number">3.4.2.5</span> Extracción de los genes diferencialmente expresados</h4>
<p>Con la gran lista de genes significativos puede ser difícil extraer una relevancia biológica significativa. Para ayudar a aumentar el rigor, también se puede añadir un umbral de cambio de pliegue. La función <code>summary()</code> no tiene un argumento para el umbral de cambio de pliegue.</p>
<p>Primero creemos variables que contengan nuestros criterios de umbral:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>padj.cutoff <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>lfc.cutoff <span class="ot">&lt;-</span> <span class="fl">0.58</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="co">#El lfc.cutoff() se establece en 0,58; recuerda que estamos trabajando con Fold Changes en log2, por lo que esto se traduce en un cambio de pliegue real de 1,5, que es bastante razonable.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Podemos subdividir fácilmente la tabla de resultados para incluir sólo aquellos que sean significativos utilizando la función <code>filter()</code>, pero primero convertiremos la tabla de resultados en un <em>tibble</em> (matriz de elementos, como una especie de data.frame mejorado para el tratamiento de datos):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>res_table_tb <span class="ot">&lt;-</span> res_table <span class="sc">%&gt;%</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">"gene"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res_table_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  gene            baseMean log2FoldChange lfcSE       pvalue        padj
  &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;       &lt;dbl&gt;
1 ENSG00000000003   4040.           1.13  0.229 0.0000000192 0.000000590
2 ENSG00000000419   3955.          -0.255 0.222 0.154        0.342      
3 ENSG00000000457   2264.           0.735 0.205 0.0000387    0.000448   
4 ENSG00000000460    566.           0.337 0.245 0.0778       0.212      
5 ENSG00000000938     31.3         -0.376 0.601 0.156        0.345      
6 ENSG00000000971   3784.           0.157 0.334 0.470        0.705      </code></pre>
</div>
</div>
<p>Ahora podemos hacer un subconjunto de esa tabla para conservar sólo los genes significativos utilizando nuestros umbrales predefinidos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>sig <span class="ot">&lt;-</span> res_table_tb <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">filter</span>(padj <span class="sc">&lt;</span> padj.cutoff <span class="sc">&amp;</span> <span class="fu">abs</span>(log2FoldChange) <span class="sc">&gt;</span> lfc.cutoff)</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  gene            baseMean log2FoldChange lfcSE        pvalue        padj
  &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
1 ENSG00000000003    4040.          1.13  0.229 0.0000000192  0.000000590
2 ENSG00000000457    2264.          0.735 0.205 0.0000387     0.000448   
3 ENSG00000001036    1678.          0.620 0.236 0.00141       0.00922    
4 ENSG00000001497    2324.         -0.734 0.332 0.00262       0.0153     
5 ENSG00000001561    3888.          1.71  0.330 0.00000000463 0.000000169
6 ENSG00000001626    4004.          1.68  0.942 0.00119       0.00803    </code></pre>
</div>
</div>
<p>¿Cuantos genes hay diferencialmente expresados en las células luminales de próstata con respecto a las basales?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>sig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,188 × 6
   gene            baseMean log2FoldChange lfcSE        pvalue        padj
   &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
 1 ENSG00000000003   4040.           1.13  0.229 0.0000000192  0.000000590
 2 ENSG00000000457   2264.           0.735 0.205 0.0000387     0.000448   
 3 ENSG00000001036   1678.           0.620 0.236 0.00141       0.00922    
 4 ENSG00000001497   2324.          -0.734 0.332 0.00262       0.0153     
 5 ENSG00000001561   3888.           1.71  0.330 0.00000000463 0.000000169
 6 ENSG00000001626   4004.           1.68  0.942 0.00119       0.00803    
 7 ENSG00000002726     57.7          2.11  0.717 0.0000513     0.000567   
 8 ENSG00000003147   3870.           1.28  0.352 0.00000482    0.0000755  
 9 ENSG00000003249    419.           1.05  0.466 0.000853      0.00613    
10 ENSG00000003400   2427.           1.89  0.353 0.00000000260 0.000000102
# ℹ 3,178 more rows</code></pre>
</div>
</div>
<section id="incorporación-del-genesymbol" class="level5">
<h5 class="anchored" data-anchor-id="incorporación-del-genesymbol">Incorporación del GeneSymbol</h5>
<p>Por último, es recomendable asignarle a cada gen su GeneSymbol, ya que es el nombre de los genes que conocemos todos. Además para las representaciones va a ser más bonito de ver con el nombre del gen que con el código de Ensembl. Para crear este listado vamos a utilizar el paquete <a href="http://127.0.0.1:13116/library/biomaRt/doc/accessing_ensembl.html"><code>biomaRt</code></a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">#para este apartado hemos intalado biomaRt</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>ensembl <span class="ot">=</span> <span class="fu">useEnsembl</span>(<span class="at">biomart=</span><span class="st">"ensembl"</span>, <span class="at">dataset=</span><span class="st">"hsapiens_gene_ensembl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Como no hemos escrito versión, accederá a la última versión que tenga registrada. Si quisieramos conectar con alguna versión antigua o de otro animal tenemos que escribir la versión:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ensembl <span class="ot">=</span> <span class="fu">useEnsembl</span>(<span class="at">biomart=</span><span class="st">"ensembl"</span>, <span class="at">dataset=</span><span class="st">"hsapiens_gene_ensembl"</span>, <span class="at">version=</span><span class="dv">78</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Para saber qué especies contiene el dataset tenemos que cargar el paquete <code>ensemble</code> completo y usar el comando <code>listDatasets(ensembl)</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>ensembl <span class="ot">=</span> <span class="fu">useEnsembl</span>(<span class="at">biomart=</span><span class="st">"ensembl"</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">listDatasets</span>(ensembl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                       dataset                           description
1 abrachyrhynchus_gene_ensembl Pink-footed goose genes (ASM259213v1)
2     acalliptera_gene_ensembl      Eastern happy genes (fAstCal1.2)
3   acarolinensis_gene_ensembl       Green anole genes (AnoCar2.0v2)
4    acchrysaetos_gene_ensembl       Golden eagle genes (bAquChr1.2)
5    acitrinellus_gene_ensembl        Midas cichlid genes (Midas_v5)
6    amelanoleuca_gene_ensembl       Giant panda genes (ASM200744v2)
      version
1 ASM259213v1
2  fAstCal1.2
3 AnoCar2.0v2
4  bAquChr1.2
5    Midas_v5
6 ASM200744v2</code></pre>
</div>
</div>
<p>Y ya seleccionariamos la versión que quisieramos.</p>
<p>Continuando con la creación del listado de códigos de equivalencias de Códigos de Ensembl con GeneSymbol, el siguiente paso consistiría en crear el listado</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Definimos el DataSet que vamos a utilizar</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>ensembl <span class="ot">=</span> <span class="fu">useEnsembl</span>(<span class="at">biomart=</span><span class="st">"ensembl"</span>, <span class="at">dataset=</span><span class="st">"hsapiens_gene_ensembl"</span>)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos un listado con getBM</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>GeneSymbolList <span class="ot">&lt;-</span><span class="fu">getBM</span>(<span class="at">attributes=</span><span class="fu">c</span>(<span class="st">'ensembl_gene_id'</span>,<span class="st">'hgnc_symbol'</span>), <span class="at">mart =</span> ensembl)</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Visualizamos el listado</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(GeneSymbolList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  ensembl_gene_id hgnc_symbol
1 ENSG00000210049       MT-TF
2 ENSG00000211459     MT-RNR1
3 ENSG00000210077       MT-TV
4 ENSG00000210082     MT-RNR2
5 ENSG00000209082      MT-TL1
6 ENSG00000198888      MT-ND1</code></pre>
</div>
</div>
<p>Ahora podemos incorporar esta info al Dataset donde tenemos los datos de Fold change con los que haremos las gráficas de representación de datos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>sig_Gene_Symbol<span class="ot">&lt;-</span><span class="fu">merge</span> (sig, GeneSymbolList, <span class="at">by.x=</span><span class="st">"gene"</span>, <span class="at">by.y=</span><span class="st">"ensembl_gene_id"</span>, <span class="at">all.x=</span><span class="cn">TRUE</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Ahora renombramos la columna que acabamos de añadir</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sig_Gene_Symbol)[<span class="dv">7</span>]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Gene_Symbol"</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Visualizamos el listado</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sig_Gene_Symbol)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             gene baseMean log2FoldChange     lfcSE       pvalue         padj
1 ENSG00000000003 4040.437      1.1276341 0.2288288 1.923117e-08 5.899186e-07
2 ENSG00000000457 2263.842      0.7348141 0.2054399 3.872069e-05 4.482583e-04
3 ENSG00000001036 1677.821      0.6195882 0.2363429 1.409314e-03 9.224009e-03
4 ENSG00000001497 2323.912     -0.7344059 0.3315479 2.619123e-03 1.532309e-02
5 ENSG00000001561 3887.750      1.7062280 0.3304577 4.630871e-09 1.694177e-07
6 ENSG00000001626 4004.007      1.6784524 0.9423249 1.189341e-03 8.031261e-03
  Gene_Symbol
1      TSPAN6
2       SCYL3
3       FUCA2
4       LAS1L
5       ENPP4
6        CFTR</code></pre>
</div>
</div>
</section>
</section>
<section id="representación-de-los-genes-más-expresados-o-de-una-maquinaria-en-concreto" class="level4" data-number="3.4.2.6">
<h4 data-number="3.4.2.6" class="anchored" data-anchor-id="representación-de-los-genes-más-expresados-o-de-una-maquinaria-en-concreto"><span class="header-section-number">3.4.2.6</span> Representación de los genes más expresados o de una maquinaria en concreto</h4>
<p>Esto suele requerir primero un poco de manipulación de los datos.</p>
<p>Vamos a trazar los valores de recuento normalizados para (por ejemplo) los 20 genes más expresados diferencialmente (por valores padj).</p>
<p>Para ello, primero tenemos que determinar los nombres de los 20 genes principales ordenando nuestros resultados y extrayendo los 20 genes principales (por valores padj):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>top20_sig_genes <span class="ot">&lt;-</span>  sig_Gene_Symbol <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(padj) <span class="sc">%&gt;%</span>   <span class="co">#Arrange rows by padj values</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pull</span>(gene) <span class="sc">%&gt;%</span>      <span class="co">#Extract character vector of ordered genes</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">head</span>(<span class="at">n=</span><span class="dv">20</span>)      <span class="co">#Extract the first 20 genes</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(top20_sig_genes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ENSG00000236699" "ENSG00000116299" "ENSG00000170961" "ENSG00000148677"
[5] "ENSG00000156966" "ENSG00000171812"</code></pre>
</div>
</div>
<div class="callout.note">
<p>Si queremos hacer la exploración de una maquinaria en concreto tenemos que crear un <code>.csv</code> que contenga el listado de los nombres de los genes que queremos extraer para cargarlos en esta variable que acabamos de crear.</p>
</div>
<p>Ahora extraemos los valores counts normalizadas de estos genes seleccionados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>top20_sig_norm <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(normalized_counts) <span class="sc">%&gt;%</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"gene"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(gene <span class="sc">%in%</span> top20_sig_genes)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(top20_sig_norm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             gene    Basal_1    Basal_2    Basal_3  Luminal_1  Luminal_2
1 ENSG00000004468   86.85545   47.82078   59.56635  836.43688  738.94772
2 ENSG00000101335 2401.50847 2922.04865 2619.89247  301.07740  333.37584
3 ENSG00000116299 1050.32417  832.87851  899.65731 6605.75777 7693.12526
4 ENSG00000140945 3908.49533 2657.04185 3016.31681   51.84114   78.56628
5 ENSG00000143416  694.84361  615.69249  600.79855 3716.61107 2966.40795
6 ENSG00000148677  131.62630  190.28684  131.45678 1638.97763 1794.28398
  Luminal_3
1 1062.3894
2  428.5948
3 7779.3994
4  138.4846
5 2878.8630
6 2040.8793</code></pre>
</div>
</div>
<p>Ahora tenemos que poner los valores en disposición x e y interpretable por ggplot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>gathered_top20_sig <span class="ot">&lt;-</span> top20_sig_norm <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(<span class="fu">colnames</span>(top20_sig_norm)[<span class="dv">2</span><span class="sc">:</span><span class="fu">ncol</span>(top20_sig_norm)], <span class="at">key =</span> <span class="st">"samplename"</span>, <span class="at">value =</span> <span class="st">"normalized_counts"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="co">#como estos son los datos que vamos a representar, añadimos los genenames oficiales</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>gathered_top20_sig <span class="ot">&lt;-</span> <span class="fu">merge</span>(gathered_top20_sig, GeneSymbolList, <span class="at">by.x=</span><span class="st">"gene"</span>, <span class="at">by.y=</span><span class="st">"ensembl_gene_id"</span>, <span class="at">all.x=</span><span class="cn">TRUE</span>)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Ahora renombramos la columna que acabamos de añadir</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(gathered_top20_sig)[<span class="fu">ncol</span>(gathered_top20_sig)]<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"Gene_Symbol"</span>)</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gathered_top20_sig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             gene samplename normalized_counts Gene_Symbol
1 ENSG00000004468    Basal_1          86.85545        CD38
2 ENSG00000004468    Basal_3          59.56635        CD38
3 ENSG00000004468  Luminal_2         738.94772        CD38
4 ENSG00000004468    Basal_2          47.82078        CD38
5 ENSG00000004468  Luminal_1         836.43688        CD38
6 ENSG00000004468  Luminal_3        1062.38940        CD38</code></pre>
</div>
</div>
<p>Ahora, si queremos nuestros “counts” coloreados por grupo de muestra, entonces necesitamos combinar la información de metadatos con los datos de recuentos normalizados fundidos en el mismo marco de datos para introducirlos en <code>ggplot()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>gathered_top20_sig <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(metaData <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"samplename"</span>), gathered_top20_sig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(samplename)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># inner_join() fusionará 2 marcos de datos con respecto a la columna "samplename" </span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co">#(por eso convertimos los roenames en una columna), es decir, una columna con </span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="co">#el mismo nombre de columna en ambos marcos de datos.</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gathered_top20_sig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  samplename cell_type            gene normalized_counts Gene_Symbol
1    Basal_1     Basal ENSG00000004468          86.85545        CD38
2    Basal_1     Basal ENSG00000101335        2401.50847        MYL9
3    Basal_1     Basal ENSG00000116299        1050.32417     ELAPOR1
4    Basal_1     Basal ENSG00000140945        3908.49533       CDH13
5    Basal_1     Basal ENSG00000143416         694.84361    SELENBP1
6    Basal_1     Basal ENSG00000148677         131.62630      ANKRD1</code></pre>
</div>
</div>
<p>Y ahora realizamos un gráfico de la expresión de los genes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gathered_top20_sig) <span class="sc">+</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Gene_Symbol, <span class="at">y =</span> normalized_counts, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">"Genes"</span>) <span class="sc">+</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ylab</span>(<span class="st">"log10 Normalized Counts"</span>) <span class="sc">+</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Top 20 Significant DE Genes"</span>) <span class="sc">+</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">6</span>)) <span class="sc">+</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-78-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Como se puede ver, esta gráfica es un jaleo porque contiene mucha info muy junta por lo que puede venir bien separar cada gen en una gráfica independiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gathered_top20_sig) <span class="sc">+</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Gene_Symbol, <span class="at">y =</span> normalized_counts, <span class="at">fill =</span> cell_type)) <span class="sc">+</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">"Genes"</span>) <span class="sc">+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ylab</span>(<span class="st">"log10 Normalized Counts"</span>) <span class="sc">+</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Top 20 Significant DE Genes"</span>) <span class="sc">+</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>gene, <span class="at">scale=</span><span class="st">"free"</span>)<span class="sc">+</span> </span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>( <span class="at">size =</span> <span class="dv">7</span>),</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>( <span class="at">size =</span> <span class="dv">5</span>),</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">face =</span> <span class="st">"bold"</span>), </span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.key.size=</span><span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">"mm"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-79-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="heatmap-1" class="level4" data-number="3.4.2.7">
<h4 data-number="3.4.2.7" class="anchored" data-anchor-id="heatmap-1"><span class="header-section-number">3.4.2.7</span> Heatmap</h4>
<p>También vamos a hacer un heatmap, en este caso de todos los genes desregulados de forma significativa. Para ello volveremos a unsar el paquete <code>pheatmap</code>. Primero tenemos que extraer todos los genes que estén significativamente desregulados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>norm_sig <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(normalized_counts) <span class="sc">%&gt;%</span> </span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"gene"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(gene <span class="sc">%in%</span> sig<span class="sc">$</span>gene) <span class="sc">%&gt;%</span> </span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">"gene"</span>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(norm_sig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Basal_1   Basal_2   Basal_3 Luminal_1 Luminal_2 Luminal_3
ENSG00000000003 2743.558 2586.3070 1909.2043  5468.243  6195.057  5340.250
ENSG00000000457 1798.893 1606.9773 1458.3486  3374.659  2550.219  2793.953
ENSG00000001036 1204.336 1148.6949 1379.2691  2542.210  1661.571  2130.844
ENSG00000001497 4052.657 2257.5391 2979.3446  1766.587  1105.236  1782.105
ENSG00000001561 1782.775 2048.3232 1300.1897  6561.892  7375.675  4257.644
ENSG00000001626 2484.782  410.4617  429.2885 13469.724  2706.290  4523.494</code></pre>
</div>
</div>
<p>A continuación vamos a crear la anotation para las muestras a partir de la metadata:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>annotation <span class="ot">&lt;-</span> metaData <span class="sc">%&gt;%</span> </span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">"samplename"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(samplename, cell_type) <span class="sc">%&gt;%</span> </span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">row.names =</span> <span class="st">"samplename"</span>)</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(annotation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          cell_type
Basal_1       Basal
Basal_2       Basal
Basal_3       Basal
Luminal_1   Luminal
Luminal_2   Luminal
Luminal_3   Luminal</code></pre>
</div>
</div>
<p>A continuación hacemos el Heatmap:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(norm_sig, </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">brewer.pal</span>(<span class="dv">6</span>, <span class="st">"YlOrRd"</span>))(<span class="dv">100</span>), </span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster_rows =</span> T, </span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_rownames =</span> F,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_colnames =</span> F,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation =</span> annotation, </span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">border_color =</span> <span class="cn">NA</span>, </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">fontsize =</span> <span class="dv">10</span>, </span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">scale =</span> <span class="st">"row"</span>, </span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">fontsize_row =</span> <span class="dv">10</span>, </span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-82-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Si tuvieramos menos genes y quisieramos visualizar el heatmap con los nombres de estos genes podríamos ponerles un <code>label</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#primero vamos a filtrar solamente los 20 más diferencialemnte expresados:</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>norm_sig_genes <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(normalized_counts) <span class="sc">%&gt;%</span> </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"gene"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>              dplyr<span class="sc">::</span><span class="fu">filter</span>(gene <span class="sc">%in%</span> top20_sig_norm<span class="sc">$</span>gene) <span class="sc">%&gt;%</span> </span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">"gene"</span>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Creamos la anotación para los genes (para las muestras vamos a utilizar la que hemos creado antes en la variable "annotation")</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>row_annotation<span class="ot">&lt;-</span>norm_sig_genes<span class="sc">%&gt;%</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">"gene"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">inner_join</span>(GeneSymbolList, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"gene"</span><span class="ot">=</span><span class="st">"ensembl_gene_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">"Gene_Symbol"</span><span class="ot">=</span><span class="st">"hgnc_symbol"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#aquí he tenido que definir la función rename con "dplyr::" como prefijo. Esto es porque hay otros paquetes que utilizan esta función y crea conflicto. Al utilizar este prefijo hacemos que solo busque la función en ese paquete</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Gene_Symbol =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Gene_Symbol) <span class="sc">|</span> Gene_Symbol <span class="sc">==</span> <span class="st">""</span>, gene, Gene_Symbol))<span class="sc">%&gt;%</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(gene,Gene_Symbol)<span class="sc">%&gt;%</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a> <span class="fu">column_to_rownames</span>(<span class="at">var=</span><span class="st">"gene"</span>)</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>row_annotation<span class="ot">&lt;-</span><span class="fu">as.data.frame</span>(row_annotation)</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a><span class="co">#Ahora se hace el gráfico</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(norm_sig_genes, </span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">brewer.pal</span>(<span class="dv">6</span>, <span class="st">"YlOrRd"</span>))(<span class="dv">100</span>), </span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">cluster_rows =</span> T, </span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_rownames =</span> T,</span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">labels_row =</span> row_annotation[,<span class="dv">1</span>],</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">show_colnames =</span> F,</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">annotation =</span> annotation, </span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">border_color =</span> <span class="cn">NA</span>, </span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">fontsize =</span> <span class="dv">10</span>, </span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">scale =</span> <span class="st">"row"</span>, </span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">fontsize_row =</span> <span class="dv">10</span>, </span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-83-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="pca" class="level4" data-number="3.4.2.8">
<h4 data-number="3.4.2.8" class="anchored" data-anchor-id="pca"><span class="header-section-number">3.4.2.8</span> PCA</h4>
<p>En este caso, para realizar el PCA vamos a utilizar una herramienta llamada <code>PCAtools</code>. Hay numerosas gráficas que podemos hacer con esta herramienta. De hecho a más variables tengamos, mayor cantidad de herramientas tendremos (<a href="http://127.0.0.1:17018/library/PCAtools/doc/PCAtools.html">enlace a la página oficial</a>). Primero creamos la variable p con la función <code>pca</code> para juntar la metadata con la matriz de datos, eliminando aqullos genes que presenten una varianza inferior al 10%:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>p<span class="ot">&lt;-</span><span class="fu">pca</span>(normalized_counts, <span class="at">metadata =</span> metaData, <span class="at">removeVar=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>-- removing the lower 10% of variables based on variance</code></pre>
</div>
</div>
<p>A continuación podemos explorar diferentes gráficos. Por ejemplo, podemos empezar con un “biplot” sencillo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>PCAtools<span class="sc">::</span><span class="fu">biplot</span>(p,</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">title =</span> <span class="st">"PCA Results"</span>,</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lab=</span><span class="cn">NULL</span>,</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">axisLabSize =</span> <span class="dv">8</span>,</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colby=</span><span class="st">"cell_type"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-85-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y vamos a añadir distintas varibales para tenerlas en cuenta:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>PCAtools<span class="sc">::</span><span class="fu">biplot</span>(p,</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">title =</span> <span class="st">"PCA Results"</span>,</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lab=</span><span class="cn">NULL</span>,</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">axisLabSize =</span> <span class="dv">8</span>,</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colby=</span><span class="st">"cell_type"</span>,</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colkey =</span> <span class="fu">c</span>(<span class="st">"Basal"</span><span class="ot">=</span><span class="st">"forestgreen"</span>, <span class="st">"Luminal"</span><span class="ot">=</span><span class="st">"lightblue"</span>),</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">encircle =</span> <span class="cn">TRUE</span>,</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">encircleFill =</span> <span class="cn">TRUE</span>,</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">legendPosition =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-86-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Y la que tanto nos gusta del metaboanalyst:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>PCAtools<span class="sc">::</span><span class="fu">biplot</span>(p,</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">title =</span> <span class="st">"PCA Results"</span>,</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">lab=</span><span class="cn">NULL</span>,</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">axisLabSize =</span> <span class="dv">8</span>,</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colby=</span><span class="st">"cell_type"</span>,</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">colkey =</span> <span class="fu">c</span>(<span class="st">"Basal"</span><span class="ot">=</span><span class="st">"forestgreen"</span>, <span class="st">"Luminal"</span><span class="ot">=</span><span class="st">"blue"</span>),</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipse =</span> <span class="cn">TRUE</span>,<span class="co"># hacemos la elipse</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseType =</span> <span class="st">"t"</span>,</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseLevel =</span> <span class="fl">0.95</span>,</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseFill =</span> <span class="cn">TRUE</span>,</span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseAlpha=</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseLineSize =</span> <span class="dv">0</span>,</span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">ellipseFillKey =</span> <span class="fu">c</span>(<span class="st">"Basal"</span><span class="ot">=</span><span class="st">"lightgreen"</span>, <span class="st">"Luminal"</span><span class="ot">=</span><span class="st">"lightblue"</span>),</span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">legendPosition =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Scale for colour is already present.
Adding another scale for colour, which will replace the existing scale.
Too few points to calculate an ellipse
Too few points to calculate an ellipse</code></pre>
</div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-87-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#En este caso sale que hay pocos puntos para generar un buen intervalo de confianza</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>También podemos hacer la representación de varias gráficas PCA de forma simultánea para así poder ver más de una opción:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pairsplot</span>(p,</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">components =</span> <span class="fu">getComponents</span>(p, <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)),</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">triangle =</span> <span class="cn">TRUE</span>, </span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trianglelabSize =</span> <span class="dv">16</span>,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">hline =</span> <span class="dv">0</span>, </span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">vline =</span> <span class="dv">0</span>,</span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pointSize =</span> <span class="dv">2</span>,</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">gridlines.major =</span> <span class="cn">FALSE</span>, </span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">gridlines.minor =</span> <span class="cn">FALSE</span>,</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">colby =</span> <span class="st">'cell_type'</span>,</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">'Pairs plot'</span>,</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">titleLabSize =</span> <span class="dv">12</span>,</span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">plotaxes =</span> <span class="cn">FALSE</span>,</span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">margingaps =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.01</span>, <span class="sc">-</span><span class="fl">0.01</span>, <span class="sc">-</span><span class="fl">0.01</span>, <span class="sc">-</span><span class="fl">0.01</span>), <span class="st">'cm'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.
Coordinate system already present. Adding new coordinate system, which will
replace the existing one.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-88-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Para ver correlaciones entre variables es recomendable explorar el paquete</p>
</section>
<section id="volcano-plot" class="level4" data-number="3.4.2.9">
<h4 data-number="3.4.2.9" class="anchored" data-anchor-id="volcano-plot"><span class="header-section-number">3.4.2.9</span> Volcano plot</h4>
<p>Para generar un volcano plot, primero necesitamos tener una columna en nuestros datos de resultados que indique si el gen se considera o no diferencialmente expresado en función de los p valores ajustados:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>res_table_tb <span class="ot">&lt;-</span> res_table_tb <span class="sc">%&gt;%</span> </span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">mutate</span>(<span class="at">threshold =</span> padj <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(log2FoldChange) <span class="sc">&gt;=</span> <span class="fl">0.58</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res_table_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  gene            baseMean log2FoldChange lfcSE       pvalue      padj threshold
  &lt;chr&gt;              &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;    
1 ENSG00000000003   4040.           1.13  0.229 0.0000000192   5.90e-7 TRUE     
2 ENSG00000000419   3955.          -0.255 0.222 0.154          3.42e-1 FALSE    
3 ENSG00000000457   2264.           0.735 0.205 0.0000387      4.48e-4 TRUE     
4 ENSG00000000460    566.           0.337 0.245 0.0778         2.12e-1 FALSE    
5 ENSG00000000938     31.3         -0.376 0.601 0.156          3.45e-1 FALSE    
6 ENSG00000000971   3784.           0.157 0.334 0.470          7.05e-1 FALSE    </code></pre>
</div>
</div>
<p>Una vez generada esta matriz ya podemos pasar a la representación de los datos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res_table_tb) <span class="sc">+</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> log2FoldChange, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(padj), <span class="at">colour =</span> threshold)) <span class="sc">+</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Luminal vs Basal"</span>) <span class="sc">+</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">"log2 fold change"</span>) <span class="sc">+</span> </span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ylab</span>(<span class="st">"-log10 adjusted p-value"</span>) <span class="sc">+</span></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">#scale_y_continuous(limits = c(0,50)) +</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.5</span>), <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.25</span>)))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-90-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Podemos poner etiquetas a los nombres de los genes con el argumento <code>geom_text_repel</code> (hay que instalarlo), pero para ello tenemos que crear una columna en la que indiquemos que genes vamos a hacer que se etiqueten:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>res_table_tb <span class="ot">&lt;-</span> res_table_tb <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(padj) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">genelabels =</span> <span class="st">""</span>)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>res_table_tb<span class="sc">$</span>genelabels[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">&lt;-</span> res_table_tb<span class="sc">$</span>gene[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(res_table_tb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 8
  gene      baseMean log2FoldChange lfcSE   pvalue     padj threshold genelabels
  &lt;chr&gt;        &lt;dbl&gt;          &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;     &lt;chr&gt;     
1 ENSG0000…    2461.           3.12 0.184 1.01e-65 1.70e-61 TRUE      ENSG00000…
2 ENSG0000…    4144.           2.95 0.185 2.26e-58 1.91e-54 TRUE      ENSG00000…
3 ENSG0000…   14383.          -3.12 0.220 8.19e-47 4.61e-43 TRUE      ENSG00000…
4 ENSG0000…     988.           3.52 0.249 1.19e-46 5.04e-43 TRUE      ENSG00000…
5 ENSG0000…    2816.           2.34 0.167 2.46e-45 8.31e-42 TRUE      ENSG00000…
6 ENSG0000…    1953.          -2.78 0.211 1.55e-40 4.35e-37 TRUE      ENSG00000…</code></pre>
</div>
</div>
<p>Ahora podemos poner este argumento adicional a ggplot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="co">#para este apartado hay que tener cargado el paquete ggrepel</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(res_table_tb, <span class="fu">aes</span>(<span class="at">x =</span> log2FoldChange, <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(padj))) <span class="sc">+</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> threshold)) <span class="sc">+</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> genelabels)) <span class="sc">+</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ggtitle</span>(<span class="st">"Luminal vs Basal"</span>) <span class="sc">+</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">xlab</span>(<span class="st">"log2 fold change"</span>) <span class="sc">+</span> </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ylab</span>(<span class="st">"-log10 adjusted p-value"</span>) <span class="sc">+</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.5</span>), <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="fu">rel</span>(<span class="fl">1.25</span>)))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-92-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="explorar-un-único-gen-de-interés" class="level4" data-number="3.4.2.10">
<h4 data-number="3.4.2.10" class="anchored" data-anchor-id="explorar-un-único-gen-de-interés"><span class="header-section-number">3.4.2.10</span> Explorar un Único gen de interés</h4>
<p>Para esto, está la función integrada en <strong>DESeq2</strong> de <code>plotCount()</code>, que lo podemos combinar con <code>ggplot</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">plotCounts</span>(dds, <span class="at">gene=</span><span class="st">"ENSG00000236699"</span>, <span class="at">intgroup=</span><span class="st">"cell_type"</span>, <span class="at">returnData=</span><span class="cn">TRUE</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting the MOV10 normalized counts, using the samplenames (rownames of d as labels)</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(d, <span class="fu">aes</span>(<span class="at">x =</span> cell_type, <span class="at">y =</span> count, <span class="at">color =</span> cell_type)) <span class="sc">+</span> </span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">position=</span><span class="fu">position_jitter</span>(<span class="at">w =</span> <span class="fl">0.1</span>,<span class="at">h =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"ENSG00000236699"</span>) <span class="sc">+</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-93-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="downstream-analysis-expñoración-de-resultados-usando-la-guía-de-clusterprofiler" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> DownStream analysis: Expñoración de resultados usando la guía de ClusterProfiler</h1>
<p>La exploración de resultados la vamos a basar en la guía de <a href="https://yulab-smu.top/biomedical-knowledge-mining-book/enrichment-overview.html">ClusterProfiler - Parte II: Overview of enrichment analysis</a> (la parte 1 puede ser liosa así que la vamos a dejar aparcada). Tenemos que instalar los siguientes paquetes:</p>
<p>El primero es <code>clusterProfiler</code>, que es el que vamos a utilizar principalmente para hacer la gran mayoría de las funciones:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"clusterProfiler"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>El paquete <code>org.Hs.eg.db</code> contiene conversión de nombres de todos los genes en los distintos formatos para humano (para consultar la disponibilidad de otros organismos consultar los paquetes disponibles en <a href="https://bioconductor.org/packages/release/BiocViews.html#___OrgDb">OrgDb</a> en Bioconductor). Se usa para lo mismo que <code>biomaRt</code>, pero en este caso tenemos que utilizar este en concreto porque está optimizado así el paquete <code>clusterProfiler</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"org.Hs.eg.db"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tambien necestaremos otros paquetes para los análisis y gráficos de los enriqueciminetos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"pathview"</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"enrichplot"</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">'ggridges'</span>)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"DOSE"</span>)</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">'msigdbr'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Y hacemos la llamada a las librerías:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(clusterProfiler)</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(org.Hs.eg.db)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pathview)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(enrichplot)</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggridges)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DOSE)</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(msigdbr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tenemos que tener en cuenta que vamos a hacer dos tipos de análisis distintos para cada una de los GeneSets que vamos a utilizar (GO, Kegg, Reactome, etc). Primero vamos a hacer un <strong>análisis de sobreexpresión de GO</strong>, lo cual consiste en examinar si un subconjunto de genes que ya se han separado se asocia significativamente con determinadas vías, mientras que el <strong>análisis de enriquecimiento de GO</strong> toma datos diferenciales de cada gen medido y busca vías que muestren cambios significativamente coordinados en esos valores.</p>
<section id="formato-de-datos" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="formato-de-datos"><span class="header-section-number">4.1</span> Formato de datos</h2>
<p>Para realizar los análsis de enriquecimiento tenemos que tener una lista de genes “rankeada” que contenga el Fold Change de cada gen, teniendo cada gen un ID único. Este listado de genes debe de cumplir las siguientes condiciones:</p>
<ol type="1">
<li>Vector numérico: cambio de pliegue u otro tipo de variable numérica</li>
<li>Vector con nombre: cada número tiene un nombre, el ID del gen correspondiente</li>
<li>Vector numérico ordenado: los números deben ordenarse de forma decreciente.</li>
</ol>
<p>Si importamos los datos desde un archivo <code>.csv</code>, el archivo debería contener dos columnas, una para el ID del gen (<strong>no se permiten ID duplicados</strong>) y otra para el Fold Change. Podemos preparar nuestra propia <code>geneList</code> mediante el siguiente comando:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">read.csv</span>(your_csv_file)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Asumimos que la primera columna es el ID</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="do">## La segunda columna es el Fold Change</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Caracaterística 1: numeric vector</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>geneList <span class="ot">=</span> d[,<span class="dv">2</span>]</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Caracaterística 2: named vector</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(geneList) <span class="ot">=</span> <span class="fu">as.character</span>(d[,<span class="dv">1</span>])</span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Caracaterística 3: decreasing orde</span></span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>geneList <span class="ot">=</span> <span class="fu">sort</span>(geneList, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>En nuestro caso, como procedemos del análisis anterior vamos a ver la preparación de la <code>GeneList</code> para que tenga estas características:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>geneList<span class="ot">&lt;-</span><span class="fu">round</span>(res_table_tb<span class="sc">$</span>log2FoldChange, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(geneList)<span class="ot">&lt;-</span>res_table_tb<span class="sc">$</span>gene</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>geneList<span class="ot">&lt;-</span> <span class="fu">sort</span>(geneList,<span class="at">decreasing =</span> T)</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ENSG00000274542 ENSG00000162040 ENSG00000211689 ENSG00000109182 ENSG00000188257 
        7.67977         5.31934         4.65300         4.54901         4.32895 
ENSG00000219814 
        4.23851 </code></pre>
</div>
</div>
<p>Tambien, por agilizar el tratameinto de datos, es recomendable pasar los códigos de “Ensembl” a códdigos de “EntrezGeneID” porque es el código que usan por defecto todos los paquetes y funciones que vamos a utilizar a continuación. Esto lo vamos a hacer con el paquete <code>org.Hs.eg.db</code> (que nos aporta el nombre de todos los genes de humano en todos los formatos) gracias a la función <code>bitr</code> del propio paquete de <code>clusterProfiler</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Primero hacemos la conversión</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>GeneNames<span class="ot">&lt;-</span><span class="fu">names</span>(geneList)</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>GeneNames_drop <span class="ot">&lt;-</span> <span class="fu">bitr</span>(GeneNames, <span class="at">fromType =</span> <span class="st">"ENSEMBL"</span>, <span class="at">toType =</span> <span class="st">"ENTREZID"</span>, <span class="at">OrgDb=</span><span class="st">"org.Hs.eg.db"</span>, <span class="at">drop=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>'select()' returned 1:many mapping between keys and columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in bitr(GeneNames, fromType = "ENSEMBL", toType = "ENTREZID", OrgDb =
"org.Hs.eg.db", : 6.67% of input gene IDs are fail to map...</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Al hacer la conversión entramos en el jodido mundo de las anotaciones de genes. Hemos podido ver que nos sale un mensaje de que se han mapeado un % de las anotaciones de ENSEMBL que ah fallado al mapear con a ENTREZ y se han rellenado con NAs (realmente se han eliminado las filas que contengan estos NA porque hemos puesto <code>drop=TRUE</code>). También, si nos damos cuenta, en la conversión anterior se crean duplicados de los “ENTEZ_ID” para la misma anotación de ENSEMBL (esto es normal porque el ENSEMBL es una anotación del genoma y el el ENTREZID es una antotación de genes propiamente dichos de manera que que hay regiones del genoma anotadas a las que todavía no se han dado un código ENTREZ; de igual manera puede haber un ENTREZID que tenga mas de una anotación de ENSMBL, pero esto no es un problema por el tratamiento de datos que vamos a hacer).</p>
</div>
</div>
<p>El siguiente código extrae los códigos ENSEMBL y los FC de nuestro dataframe <code>geneList</code>, y lo vamos a ir viendo paso a paso (realmente esto es para ver lo que va haciendo el código, lo que hay que escribir es directamente el último código completo y lo hace todo del tirón). Primero definimos <code>geneList</code> como el dataframe que vamos a modificar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ENSG00000274542 ENSG00000162040 ENSG00000211689 ENSG00000109182 ENSG00000188257 
        7.67977         5.31934         4.65300         4.54901         4.32895 
ENSG00000219814 
        4.23851 </code></pre>
</div>
</div>
<p><code>%&gt;%</code> lo convertimos en un tibble estableciendo como nombre de filas el la columna del “ENSEMBL_ID”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  ENSEMBL         value
  &lt;chr&gt;           &lt;dbl&gt;
1 ENSG00000274542  7.68
2 ENSG00000162040  5.32
3 ENSG00000211689  4.65
4 ENSG00000109182  4.55
5 ENSG00000188257  4.33
6 ENSG00000219814  4.24</code></pre>
</div>
</div>
<p><code>%&gt;%</code> le unimos (como una especie de <code>merge</code>) la columna de “ENTREZ_ID” que se encuentra en el dataset de las conversiones <code>GeneNames_drop</code> en función de la columna “ENSEMBL”,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GeneNames_drop, <span class="at">by=</span><span class="st">"ENSEMBL"</span>)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  ENSEMBL         value ENTREZID
  &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;   
1 ENSG00000274542  7.68 1139    
2 ENSG00000162040  5.32 64711   
3 ENSG00000211689  4.65 6966    
4 ENSG00000211689  4.65 445347  
5 ENSG00000109182  4.55 80157   
6 ENSG00000188257  4.33 5320    </code></pre>
</div>
</div>
<p><code>%&gt;%</code> a continuación se queda solo con aquellas filas que no tienen NA en la columna de “ENTREZ_ID”,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GeneNames_drop, <span class="at">by=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID))</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  ENSEMBL         value ENTREZID
  &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;   
1 ENSG00000274542  7.68 1139    
2 ENSG00000162040  5.32 64711   
3 ENSG00000211689  4.65 6966    
4 ENSG00000211689  4.65 445347  
5 ENSG00000109182  4.55 80157   
6 ENSG00000188257  4.33 5320    </code></pre>
</div>
</div>
<p><code>%&gt;%</code> agrupamos los valores de todss las filas que tengan el mismo “ENTREZ_ID” (genera como una especie de almacenamiento de datos por capas de manera que tenemos también una tercera dimensión de almacenamiento de datos como en el lenguaje SQL),</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GeneNames_drop, <span class="at">by=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID)) <span class="sc">%&gt;%</span> </span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ENTREZID)</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
# Groups:   ENTREZID [6]
  ENSEMBL         value ENTREZID
  &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;   
1 ENSG00000274542  7.68 1139    
2 ENSG00000162040  5.32 64711   
3 ENSG00000211689  4.65 6966    
4 ENSG00000211689  4.65 445347  
5 ENSG00000109182  4.55 80157   
6 ENSG00000188257  4.33 5320    </code></pre>
</div>
</div>
<p><code>%&gt;%</code> a continuación redefinimos la columna value (que contiene los FC) como la <strong>media</strong> de los FC que correspondan al mismo ENTREZID <em>(en este paso no definimos qué hacer con la columna de los ENSEMBL_ID de manera que se eliminan y nos quedamos con dos columnas: una primera columna de “ENTREZ_ID” y una segunda con los valores de los FC)</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GeneNames_drop, <span class="at">by=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID)) <span class="sc">%&gt;%</span> </span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ENTREZID) <span class="sc">%&gt;%</span> </span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">log2FC=</span><span class="fu">mean</span>(value))</span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  ENTREZID   log2FC
  &lt;chr&gt;       &lt;dbl&gt;
1 1         -0.143 
2 1000      -1.12  
3 10000      0.101 
4 10001     -0.0244
5 10002      0.0923
6 100037417  0.301 </code></pre>
</div>
</div>
<p><code>%&gt;%</code> y por úlimo ordenamos de forma desdendente porque es el imput que necesitamos. <strong>NOTA:</strong> <em>este es el único código final que hay que poner para que haga todo lo anterior</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>geneList_treat<span class="ot">&lt;-</span>geneList <span class="sc">%&gt;%</span> </span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="at">rownames=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GeneNames_drop, <span class="at">by=</span><span class="st">"ENSEMBL"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(ENTREZID)) <span class="sc">%&gt;%</span> </span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ENTREZID) <span class="sc">%&gt;%</span> </span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">log2FC=</span><span class="fu">mean</span>(value)) <span class="sc">%&gt;%</span> </span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(log2FC))</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(geneList_treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 2
  ENTREZID log2FC
  &lt;chr&gt;     &lt;dbl&gt;
1 445347     4.65
2 6966       4.65
3 80157      4.55
4 5320       4.33
5 729277     4.24
6 131034     4.23</code></pre>
</div>
</div>
<p>Pero todavía no tenemos un listado compatible con los análisis que vamos a hacer de manera que tenemos que hacer que este último resultado esté en formato de vector:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>ENTREZ_geneList<span class="ot">&lt;-</span><span class="fu">setNames</span>(geneList_treat<span class="sc">$</span>log2FC,geneList_treat<span class="sc">$</span>ENTREZID)</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ENTREZ_geneList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 445347    6966   80157    5320  729277  131034 
4.65300 4.65300 4.54901 4.32895 4.23851 4.23195 </code></pre>
</div>
</div>
<p>Con esto tendremos un listado de todos los genes en EntrezID con su correspondiente valor de Fold Change.</p>
</section>
<section id="gene-ontology-go-analysis" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="gene-ontology-go-analysis"><span class="header-section-number">4.2</span> Gene Ontology (GO) Analysis</h2>
<section id="sobreexpresión-de-go" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="sobreexpresión-de-go"><span class="header-section-number">4.2.1</span> Sobreexpresión de GO</h3>
<p>Para comenzar vamos a comenzar haciendo un análisis de enriquecimiento en GO. Tras tener nuestro listado preparado debemos filtrar aquellos genes que tengan un Fold Change elevado (cada uno puede establecer el Fold Change mínimo que quiera, en nuestro caso vamos a utilizar un valor de 2 para buscar cambios fuertes):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>gene<span class="ot">&lt;-</span><span class="fu">names</span>(ENTREZ_geneList)[<span class="fu">abs</span>(ENTREZ_geneList) <span class="sc">&gt;</span> <span class="dv">2</span>]</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gene)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "445347" "6966"   "80157"  "5320"   "729277" "131034"</code></pre>
</div>
</div>
<p>Y ahora hacemos el análisis GO propiamente dicho (en este ejemplo vamos a haer el análsisi por “biological Process”).</p>
<p>Primero podemos generar una tabla que representa todos lo procesos en los que se ven implicados nuestro listado de genes (que no sería el análisis de enriquecimiento propiamente dicho):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>ego <span class="ot">&lt;-</span> <span class="fu">enrichGO</span>(<span class="at">gene     =</span> gene,</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">universe =</span> <span class="fu">names</span>(ENTREZ_geneList),</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>                <span class="co">#Con el argumento "universe definimos el background. Si no lo defininmos usará el de la base que estamos introduciendo (los mismos que está muy deregulados), de manera que lo más correcto es poner toda la cadena de genes previa al filtro</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">OrgDb         =</span> org.Hs.eg.db,</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">ont           =</span> <span class="st">"BP"</span>, <span class="co">#One of "BP", "MF", and "CC" subontologies, or "ALL" for all three.</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">pAdjustMethod =</span> <span class="st">"BH"</span>, <span class="co">#one of "holm", "hochberg", "hommel", "bonferroni", "BH", "BY", "fdr", "none"</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">pvalueCutoff  =</span> <span class="fl">0.01</span>,</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">qvalueCutoff  =</span> <span class="fl">0.05</span>)</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ego)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   ID                                   Description GeneRatio
GO:0030198 GO:0030198             extracellular matrix organization    42/503
GO:0045229 GO:0045229 external encapsulating structure organization    42/503
GO:0043062 GO:0043062          extracellular structure organization    42/503
GO:0001525 GO:0001525                                  angiogenesis    43/503
GO:0099177 GO:0099177        regulation of trans-synaptic signaling    37/503
GO:0030282 GO:0030282                           bone mineralization    18/503
             BgRatio       pvalue     p.adjust       qvalue
GO:0030198 256/13334 5.146233e-16 7.972669e-13 6.676722e-13
GO:0045229 256/13334 5.146233e-16 7.972669e-13 6.676722e-13
GO:0043062 257/13334 5.940886e-16 7.972669e-13 6.676722e-13
GO:0001525 429/13334 4.610318e-09 4.640285e-06 3.886012e-06
GO:0099177 357/13334 2.392500e-08 1.926441e-05 1.613300e-05
GO:0030282 100/13334 3.078649e-08 2.065774e-05 1.729985e-05
                                                                                                                                                                                                                                       geneID
GO:0030198         1803/9622/183/1297/27035/55512/55790/3549/92949/3936/9806/4316/7837/3908/5268/4312/9510/4313/4321/1294/1282/7092/1284/1296/7373/1287/857/6624/11095/11096/144165/3037/4319/50509/165/1288/10631/4318/91522/10630/4314/1308
GO:0045229         1803/9622/183/1297/27035/55512/55790/3549/92949/3936/9806/4316/7837/3908/5268/4312/9510/4313/4321/1294/1282/7092/1284/1296/7373/1287/857/6624/11095/11096/144165/3037/4319/50509/165/1288/10631/4318/91522/10630/4314/1308
GO:0043062         1803/9622/183/1297/27035/55512/55790/3549/92949/3936/9806/4316/7837/3908/5268/4312/9510/4313/4321/1294/1282/7092/1284/1296/7373/1287/857/6624/11095/11096/144165/3037/4319/50509/165/1288/10631/4318/91522/10630/4314/1308
GO:0001525 1139/354/183/54567/27035/10267/3549/6376/1950/290/7837/1636/154796/144455/54922/2316/154810/2246/2069/3592/9510/4313/140862/57007/6422/5054/1282/4897/3552/1893/1284/1296/857/6678/7058/83700/4804/1464/7476/3553/8091/1012/147372
GO:0099177                                1128/1139/594855/952/4852/183/22999/8564/9066/5764/388336/6376/79772/55607/2852/10718/2904/1636/2914/3908/2534/1268/5924/22854/140730/2171/3814/440279/1009/6507/6622/9148/9162/4804/7476/3553/2903
GO:0030282                                                                                                                              84059/5764/100533183/144347/55512/4057/658/9365/4745/1594/54361/5744/655/359845/1893/2719/144165/2261
           Count
GO:0030198    42
GO:0045229    42
GO:0043062    42
GO:0001525    43
GO:0099177    37
GO:0030282    18</code></pre>
</div>
</div>
</section>
<section id="análisis-de-enriquecimiento" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="análisis-de-enriquecimiento"><span class="header-section-number">4.2.2</span> Análisis de enriquecimiento</h3>
<p>Y a continuación hacemos el análsis de <strong>enriquecimiento de GO</strong>. Para este análisis sí usamos el geneList completo porque vamos a comparar todos los genes y ver qué rutas se enriquecen más en función del Fold Change de todos ellos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>ego3 <span class="ot">&lt;-</span> <span class="fu">gseGO</span>(<span class="at">geneList     =</span> ENTREZ_geneList,</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">OrgDb        =</span> org.Hs.eg.db,</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">ont          =</span> <span class="st">"BP"</span>,</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">minGSSize    =</span> <span class="dv">100</span>,</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">maxGSSize    =</span> <span class="dv">400</span>,</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>              <span class="co">#Con este argumento definimos el tamaño máximo del GeneSet que se va a utilizar (los más generales tiene más genes y son menos informativos)</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">pvalueCutoff =</span> <span class="fl">0.05</span>,</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose      =</span> <span class="cn">FALSE</span>)</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a><span class="fu">goplot</span>(ego3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-111-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="kegg-analysis" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="kegg-analysis"><span class="header-section-number">4.3</span> Kegg Analysis</h2>
<p>El paquete clusterProfiler es compatible con todos los organismos que disponen de datos de anotación KEGG en la base de datos KEGG. Los usuarios deben pasar una abreviatura del nombre académico al parámetro <code>organism</code>. Como argumento podemos utilizar cualquier organimo disponible en la página oficial de Kegg. De igual manera que para el análisis de GO, para Kegg también tenemos dos tipos de análisis: <strong>análisis de sobre-representación de ruta Kegg</strong> o <strong>análisis de enriquecimiento de ruta Kegg</strong>.</p>
<section id="análisis-de-sobre-representación-de-ruta-kegg" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="análisis-de-sobre-representación-de-ruta-kegg"><span class="header-section-number">4.3.1</span> Análisis de sobre-representación de ruta Kegg</h3>
<p>Se realiza de igual forma que el análisis GO, solo cambian algunos argumentos:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>kk <span class="ot">&lt;-</span> <span class="fu">enrichKEGG</span>(<span class="at">gene         =</span> gene,</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">organism     =</span> <span class="st">'hsa'</span>,</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pvalueCutoff =</span> <span class="fl">0.05</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Reading KEGG annotation online: "https://rest.kegg.jp/link/hsa/pathway"...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in utils::download.file(url, quiet = TRUE, method = method, ...): the
'wininet' method is deprecated for http:// and https:// URLs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Reading KEGG annotation online: "https://rest.kegg.jp/list/pathway/hsa"...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in utils::download.file(url, quiet = TRUE, method = method, ...): the
'wininet' method is deprecated for http:// and https:// URLs</code></pre>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(kk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               ID                                          Description
hsa04974 hsa04974                     Protein digestion and absorption
hsa04512 hsa04512                             ECM-receptor interaction
hsa04933 hsa04933 AGE-RAGE signaling pathway in diabetic complications
hsa04510 hsa04510                                       Focal adhesion
hsa04614 hsa04614                             Renin-angiotensin system
hsa04972 hsa04972                                 Pancreatic secretion
         GeneRatio  BgRatio       pvalue     p.adjust       qvalue
hsa04974    14/250 103/8586 1.493116e-06 0.0004240448 0.0003850666
hsa04512    11/250  89/8586 5.018667e-05 0.0071265069 0.0064714388
hsa04933    11/250 100/8586 1.467951e-04 0.0138966016 0.0126192268
hsa04510    16/250 203/8586 2.763370e-04 0.0196199277 0.0178164651
hsa04614     5/250  23/8586 4.400496e-04 0.0249948162 0.0226972942
hsa04972    10/250 102/8586 7.413350e-04 0.0300770193 0.0273123415
                                                                                  geneID
hsa04974          1803/1360/1297/486/1294/1282/1284/1296/7373/1287/50509/1288/91522/1308
hsa04512                          1297/3908/3691/3655/1282/1284/1287/7058/1288/3371/3676
hsa04933                          183/27035/7056/4313/5054/1282/3552/1284/1287/1288/3553
hsa04510 1297/1950/3908/3691/2534/2316/3655/1282/1284/10398/1287/857/7058/1288/3371/3676
hsa04614                                                          3817/183/3816/290/1636
hsa04972                                  5320/952/885/1360/64600/489/5874/1056/486/3778
         Count
hsa04974    14
hsa04512    11
hsa04933    11
hsa04510    16
hsa04614     5
hsa04972    10</code></pre>
</div>
</div>
<p>Ya tenemos un listado de las listas más significativas, ahora podemos hacer cosas como habrír una ruta KEGG on line en la cual se nos indicarán nuestros genes en rojo. Tenemos que seleccionar alguna ruta que nos haya salido en el análisis de <strong>over-representation</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">browseKEGG</span>(kk, <span class="st">'hsa04974'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="análisis-de-enriquecimiento-gsea-de-ruta-kegg" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="análisis-de-enriquecimiento-gsea-de-ruta-kegg"><span class="header-section-number">4.3.2</span> Análisis de enriquecimiento (GSEA) de ruta Kegg</h3>
<p>Ahora haríamos el enriquecimiento:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>mkk2 <span class="ot">&lt;-</span> <span class="fu">gseMKEGG</span>(<span class="at">geneList =</span> ENTREZ_geneList,</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">organism =</span> <span class="st">'hsa'</span>,</span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pvalueCutoff =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Reading KEGG annotation online: "https://rest.kegg.jp/link/hsa/module"...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in utils::download.file(url, quiet = TRUE, method = method, ...): the
'wininet' method is deprecated for http:// and https:// URLs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Reading KEGG annotation online: "https://rest.kegg.jp/list/module"...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in utils::download.file(url, quiet = TRUE, method = method, ...): the
'wininet' method is deprecated for http:// and https:// URLs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>preparing geneSet collections...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>GSEA analysis...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in preparePathwaysAndStats(pathways, stats, minSize, maxSize, gseaParam, : There are ties in the preranked stats (5.53% of the list).
The order of those tied genes will be arbitrary, which may produce unexpected results.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>leading edge analysis...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>done...</code></pre>
</div>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mkk2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           ID                                               Description setSize
M00034 M00034                                Methionine salvage pathway      12
M00001 M00001 Glycolysis (Embden-Meyerhof pathway), glucose =&gt; pyruvate      19
M00912 M00912        NAD biosynthesis, tryptophan =&gt; quinolinate =&gt; NAD      10
M00158 M00158                                 F-type ATPase, eukaryotes      17
M00050 M00050       Guanine ribonucleotide biosynthesis, IMP =&gt; GDP,GTP      12
M00087 M00087                                            beta-Oxidation      12
       enrichmentScore       NES      pvalue  p.adjust    qvalue rank
M00034      -0.7783792 -1.760118 0.003909259 0.1485518 0.1440253 1249
M00001      -0.6566308 -1.625438 0.018660476 0.2851396 0.2764512 4010
M00912       0.7626680  1.618179 0.022511022 0.2851396 0.2764512  729
M00158      -0.6162543 -1.481003 0.056339526 0.4137931 0.4011844 3945
M00050      -0.6508136 -1.471659 0.061833689 0.4137931 0.4011844 2912
M00087       0.6450831  1.431263 0.069418386 0.4137931 0.4011844 3219
                         leading_edge
M00034  tags=33%, list=8%, signal=31%
M00001 tags=74%, list=26%, signal=55%
M00912  tags=30%, list=5%, signal=29%
M00158 tags=59%, list=26%, signal=44%
M00050 tags=67%, list=19%, signal=54%
M00087 tags=50%, list=21%, signal=40%
                                                             core_enrichment
M00034                                                  58478/4507/6723/4143
M00001 3098/5230/226/7167/5315/2821/2027/83440/2597/5214/2023/5223/2645/5213
M00912                                                        8564/3620/8942
M00158                             521/498/509/515/4508/516/4509/506/518/513
M00050                             2987/4833/8833/4831/3615/654364/4830/3614
M00087                                              1962/33/10449/51/8310/37</code></pre>
</div>
</div>
<p>Y podremos hacer cosas como la siguiente:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>hsa04110 <span class="ot">&lt;-</span> <span class="fu">pathview</span>(<span class="at">gene.data  =</span> ENTREZ_geneList,</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">pathway.id =</span> <span class="st">"hsa04974"</span>,</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">species    =</span> <span class="st">"hsa"</span>,</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">limit      =</span> <span class="fu">list</span>(<span class="at">gene=</span><span class="fu">max</span>(<span class="fu">abs</span>(ENTREZ_geneList)), <span class="at">cpd=</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>'select()' returned 1:1 mapping between keys and columns</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Info: Working in directory E:/Accesos directos Importantes/R_Projects/Learning</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Info: Writing image file hsa04974.pathview.png</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Info: some node width is different from others, and hence adjusted!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>image <span class="ot">&lt;-</span> <span class="fu">image_read</span>(<span class="st">"E:/Accesos directos Importantes/Estancia CRG/Apuntes/3 Bulk RNAseq/R_workspace/hsa04974.pathview.png"</span>)</span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(image, <span class="at">info=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-115-1.png" class="img-fluid" width="580"></p>
</div>
</div>
</section>
</section>
<section id="gsea-analisis-msigdb" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="gsea-analisis-msigdb"><span class="header-section-number">4.4</span> GSEA Analisis (MSigDb)</h2>
<p>Este es el GSEA que conocemos de usarlo en el laboratorio. Creo que estabamos todos errados creyendo que erea el único GSEA que que existía porque ya estamos viendo que se puede hacer con cualquier base de datos. Este está basado en Molecular Signatures Database (MSigDb), que consiste en una colección gene sets con annotaciones a rutas. Como sabeis hay varias categorías de GSEA:</p>
<ol type="1">
<li>H: hallmark gene sets</li>
<li>C1: Gene Sets posicionales</li>
<li>C2: Gene Sets curados</li>
<li>C3: Gene Sets con motivos</li>
<li>C4: Gene Sets computacionales</li>
<li>C5: Gene Sets GO</li>
<li>C6: signatures oncogénicas</li>
<li>C7: signatures inmunológicas</li>
</ol>
<p>De manera que antes de comezar a hacer cualquier tipo de análisis hay que definir la categoría que queremos analizar:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>GSEA_H <span class="ot">&lt;-</span> <span class="fu">msigdbr</span>(<span class="at">species =</span> <span class="st">"Homo sapiens"</span>, <span class="at">category =</span> <span class="st">"H"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(gs_name, entrez_gene)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Over-representation</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>em <span class="ot">&lt;-</span> <span class="fu">enricher</span>(gene, <span class="at">TERM2GENE=</span>GSEA_H)</span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(em)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                                   ID
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION
HALLMARK_MYOGENESIS                                               HALLMARK_MYOGENESIS
HALLMARK_APICAL_JUNCTION                                     HALLMARK_APICAL_JUNCTION
HALLMARK_COAGULATION                                             HALLMARK_COAGULATION
                                                                          Description
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION
HALLMARK_MYOGENESIS                                               HALLMARK_MYOGENESIS
HALLMARK_APICAL_JUNCTION                                     HALLMARK_APICAL_JUNCTION
HALLMARK_COAGULATION                                             HALLMARK_COAGULATION
                                           GeneRatio  BgRatio       pvalue
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION    36/191 200/4383 6.292591e-14
HALLMARK_MYOGENESIS                           19/191 200/4383 9.709807e-04
HALLMARK_APICAL_JUNCTION                      18/191 200/4383 2.438629e-03
HALLMARK_COAGULATION                          14/191 138/4383 2.474245e-03
                                               p.adjust       qvalue
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION 2.768740e-12 2.252085e-12
HALLMARK_MYOGENESIS                        2.136158e-02 1.737544e-02
HALLMARK_APICAL_JUNCTION                   2.721669e-02 2.213798e-02
HALLMARK_COAGULATION                       2.721669e-02 2.213798e-02
                                                                                                                                                                                                                            geneID
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION 290/6641/3908/2817/3487/4232/2316/4312/10085/1462/5744/4313/6586/6422/3485/5054/1294/1282/26577/1893/1284/627/1296/1009/10398/11010/6678/7058/7169/3624/6424/50509/10631/3371/6876/4314
HALLMARK_MYOGENESIS                                                                                                              25803/8912/4151/1837/11156/29970/3908/3691/6261/4842/10468/1284/6678/7169/165/2273/6876/3490/1012
HALLMARK_APICAL_JUNCTION                                                                                                            1297/247/6376/3691/1825/84552/8745/1462/4313/5010/1009/10398/6624/11096/83700/143903/4318/1308
HALLMARK_COAGULATION                                                                                                                                         1803/3158/4316/2534/2161/7056/4312/4313/5055/5054/6678/4319/4318/4314
                                           Count
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION    36
HALLMARK_MYOGENESIS                           19
HALLMARK_APICAL_JUNCTION                      18
HALLMARK_COAGULATION                          14</code></pre>
</div>
</div>
<ul>
<li>GSEA</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>em2 <span class="ot">&lt;-</span> <span class="fu">GSEA</span>(ENTREZ_geneList, <span class="at">TERM2GENE =</span> GSEA_H)</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(em2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                                                   ID
HALLMARK_MYC_TARGETS_V1                                       HALLMARK_MYC_TARGETS_V1
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION
HALLMARK_MYC_TARGETS_V2                                       HALLMARK_MYC_TARGETS_V2
HALLMARK_INTERFERON_GAMMA_RESPONSE                 HALLMARK_INTERFERON_GAMMA_RESPONSE
HALLMARK_E2F_TARGETS                                             HALLMARK_E2F_TARGETS
HALLMARK_BILE_ACID_METABOLISM                           HALLMARK_BILE_ACID_METABOLISM
                                                                          Description
HALLMARK_MYC_TARGETS_V1                                       HALLMARK_MYC_TARGETS_V1
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION
HALLMARK_MYC_TARGETS_V2                                       HALLMARK_MYC_TARGETS_V2
HALLMARK_INTERFERON_GAMMA_RESPONSE                 HALLMARK_INTERFERON_GAMMA_RESPONSE
HALLMARK_E2F_TARGETS                                             HALLMARK_E2F_TARGETS
HALLMARK_BILE_ACID_METABOLISM                           HALLMARK_BILE_ACID_METABOLISM
                                           setSize enrichmentScore       NES
HALLMARK_MYC_TARGETS_V1                        196      -0.6838009 -2.508826
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION     186      -0.6521398 -2.384998
HALLMARK_MYC_TARGETS_V2                         56      -0.7829536 -2.366002
HALLMARK_INTERFERON_GAMMA_RESPONSE             183       0.5484440  1.963996
HALLMARK_E2F_TARGETS                           197      -0.5122329 -1.884108
HALLMARK_BILE_ACID_METABOLISM                   98       0.5695655  1.879396
                                                 pvalue     p.adjust
HALLMARK_MYC_TARGETS_V1                    1.000000e-10 2.500000e-09
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION 1.000000e-10 2.500000e-09
HALLMARK_MYC_TARGETS_V2                    1.870533e-10 3.117556e-09
HALLMARK_INTERFERON_GAMMA_RESPONSE         4.769111e-08 5.961389e-07
HALLMARK_E2F_TARGETS                       1.855929e-07 1.855929e-06
HALLMARK_BILE_ACID_METABOLISM              2.278905e-05 1.899088e-04
                                                 qvalue rank
HALLMARK_MYC_TARGETS_V1                    1.105263e-09 4003
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION 1.105263e-09 1033
HALLMARK_MYC_TARGETS_V2                    1.378288e-09 1673
HALLMARK_INTERFERON_GAMMA_RESPONSE         2.635561e-07 3922
HALLMARK_E2F_TARGETS                       8.205161e-07 4265
HALLMARK_BILE_ACID_METABOLISM              8.395966e-05 2408
                                                             leading_edge
HALLMARK_MYC_TARGETS_V1                    tags=76%, list=26%, signal=57%
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION  tags=34%, list=7%, signal=32%
HALLMARK_MYC_TARGETS_V2                    tags=71%, list=11%, signal=64%
HALLMARK_INTERFERON_GAMMA_RESPONSE         tags=51%, list=25%, signal=38%
HALLMARK_E2F_TARGETS                       tags=52%, list=28%, signal=38%
HALLMARK_BILE_ACID_METABOLISM              tags=36%, list=16%, signal=30%
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          core_enrichment
HALLMARK_MYC_TARGETS_V1                    5230/6637/5887/6164/6626/5683/6434/65005/890/8894/9377/6428/11335/6175/5704/7514/26354/10935/4999/6629/5709/23435/3183/7419/2079/7555/6634/6141/10213/4176/3838/26986/2935/7411/6627/8454/9868/57819/4686/1977/5688/5496/6204/5707/23196/3608/8669/7458/220988/26121/22916/6146/6194/10907/5478/2058/4706/3066/3735/7307/4173/2806/6128/2547/6188/10155/7965/7203/8664/6427/10921/7284/10549/10971/6432/10728/3178/1965/1537/22948/23016/9045/6741/10054/3184/3192/3336/10574/2107/10399/10575/5634/6193/51690/11331/6633/54107/11260/1964/7416/23450/10576/10528/51020/6418/3837/1207/26156/4953/7027/6950/10856/8886/3326/6632/1973/8662/3615/8761/6059/26135/11137/1933/5245/5901/10146/5425/55651/5036/3251/3329/4830/708/4869/4673/10492/9188/51491/1503/9221/2091/1019/4609/4175/4171/790/5902/9136/6723
HALLMARK_EPITHELIAL_MESENCHYMAL_TRANSITION                                                                                                                                                                                                                                                                                                                                                                                                                                                                             7980/3909/2014/3688/25878/1647/79709/5654/2192/30008/10272/1000/6382/4016/1303/2882/649/374/4035/3491/2697/284217/22943/3956/7040/667/6591/7078/800/3908/2817/3487/4232/2316/4312/10085/1462/5744/4313/6586/6422/3485/5054/1294/1282/26577/1893/1284/627/1296/1009/10398/11010/6678/7058/7169/3624/6424/50509/10631/3371/6876/4314
HALLMARK_MYC_TARGETS_V2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       3336/3177/6832/83743/64216/9238/79077/2193/4839/10528/81887/8886/29078/705/92856/23481/5245/10171/5036/56915/23160/10196/3329/6949/51388/27340/80324/4869/51491/56342/9221/51154/1019/6573/4609/10514/23223/10244/9136/6723
HALLMARK_INTERFERON_GAMMA_RESPONSE                                                                                                                                                                                                                                                                                                               952/6398/3620/3108/8743/629/219285/81030/55024/972/4261/5142/57674/716/10906/10875/669/3569/710/5359/94240/8767/8673/3430/5777/1439/3627/837/84159/10628/840/80830/4283/3394/4939/10561/3123/115361/91543/3429/55601/5699/6373/54625/3717/3091/3431/6772/9246/55008/3383/3665/9111/7127/6773/5743/6774/129607/5698/10964/3600/3669/4600/8202/23424/10437/9961/3117/7130/10791/684/6775/84166/27348/23586/9021/3455/4061/57169/3434/836/841/57162/10135/6347/3437/116071/10379/8082/64761/567/7453/317649
HALLMARK_E2F_TARGETS                                                                                                                                                                                                                                                                            11004/9700/3159/6426/79075/4085/332/3014/675/5511/6434/6839/11200/9126/5347/10733/6790/9212/10274/5982/7514/4999/983/1164/6241/5395/147841/51155/55635/4176/3838/2935/9837/7374/23468/7884/5631/4678/11340/27338/23649/3930/84844/10527/580/51747/4173/2547/9972/6427/7153/10212/5411/10549/11051/29893/10111/57122/84312/204/1965/79677/9125/23165/1633/701/6628/3609/3184/1111/3070/5424/9238/54962/79077/4172/1786/10460/10528/10797/64785/6749/5591/1434/5901/5425/5036/7037/4830/4673/10492/10606/1503/9221/1019/4609/4175/55646/4171/5902/9319/9232
HALLMARK_BILE_ACID_METABOLISM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         8630/9963/189/27232/51170/51302/367/1718/8800/1593/654/24/3417/3418/2053/3992/9415/51703/2180/4306/3295/847/92960/1734/6342/3932/5825/5194/10133/2730/11001/50640/23461/80270/23600</code></pre>
</div>
</div>
</section>
<section id="network-of-cancer-genes-ncg-analisis" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="network-of-cancer-genes-ncg-analisis"><span class="header-section-number">4.5</span> Network of Cancer Genes (NCG) Analisis</h2>
<p><strong>Network of Cancer Gene (NCG)</strong> <a href="https://yulab-smu.top/biomedical-knowledge-mining-book/references.html#ref-omer_ncg">(A. et al.&nbsp;2016)</a> es un repositorio generado de forma naualde genes implicados en cáncer. La versión 5.0 de NCG (agosto de 2015) recoge 1.571 genes del cáncer de 175 estudios publicados. El paquete <code>DOSE</code> permite analizar la lista de genes y determinar si están enriquecidos en genes que se sabe que están mutados en un determinado tipo de cáncer.</p>
<p>También podemos realizar los dos tipos de análisis:</p>
<ul>
<li>Over-representation</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>edo<span class="ot">&lt;-</span><span class="fu">enrichNCG</span>(gene)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(edo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ID          Description GeneRatio   BgRatio     pvalue      p.adjust   
[7] qvalue      geneID      Count      
&lt;0 rows&gt; (or 0-length row.names)</code></pre>
</div>
</div>
<ul>
<li>GSEA</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>ncg <span class="ot">&lt;-</span> <span class="fu">gseNCG</span>(ENTREZ_geneList,</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">pvalueCutoff  =</span> <span class="fl">0.5</span>,</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">pAdjustMethod =</span> <span class="st">"BH"</span>,</span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose       =</span> <span class="cn">FALSE</span>)</span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>ncg <span class="ot">&lt;-</span> <span class="fu">setReadable</span>(ncg, <span class="st">'org.Hs.eg.db'</span>)</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ncg, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                               ID
chronic_myeloid_leukemia                 chronic_myeloid_leukemia
pancreatic_ductal_adenocarcinoma pancreatic_ductal_adenocarcinoma
lung_squamous_cell_carcinoma         lung_squamous_cell_carcinoma
                                                      Description setSize
chronic_myeloid_leukemia                 chronic_myeloid_leukemia      25
pancreatic_ductal_adenocarcinoma pancreatic_ductal_adenocarcinoma     121
lung_squamous_cell_carcinoma         lung_squamous_cell_carcinoma      20
                                 enrichmentScore       NES      pvalue
chronic_myeloid_leukemia              -0.6899982 -1.775986 0.001608256
pancreatic_ductal_adenocarcinoma      -0.4578916 -1.596532 0.001173594
lung_squamous_cell_carcinoma          -0.6855268 -1.671460 0.008245063
                                   p.adjust     qvalue rank
chronic_myeloid_leukemia         0.06835087 0.06094443  209
pancreatic_ductal_adenocarcinoma 0.06835087 0.06094443 1558
lung_squamous_cell_carcinoma     0.21629783 0.19285998 1398
                                                   leading_edge
chronic_myeloid_leukemia          tags=36%, list=1%, signal=36%
pancreatic_ductal_adenocarcinoma tags=21%, list=10%, signal=19%
lung_squamous_cell_carcinoma      tags=30%, list=9%, signal=27%
                                                                                                                                                                     core_enrichment
chronic_myeloid_leukemia                                                                                                        MSH6/FGF2/UCHL5/NR3C1/SETBP1/COL7A1/FAT3/CSPG4/CSMD2
pancreatic_ductal_adenocarcinoma COL5A1/GLI3/TYSND1/ELN/NRG2/RASSF6/RP1L1/SFXN4/WDR75/DOCK2/PREX2/UTP20/CEP83/TGFBR2/IRF6/SCN5A/VWF/CARD10/FMNL3/FAT2/UNC13C/COL14A1/DLC1/IL1B/CDH13
lung_squamous_cell_carcinoma                                                                                                                     ZNF521/EPB41L3/FAT4/NAV3/WIF1/CDH11</code></pre>
</div>
</div>
</section>
<section id="graficando-los-análisis-de-over-representation-y-gsea" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="graficando-los-análisis-de-over-representation-y-gsea"><span class="header-section-number">4.6</span> Graficando los análisis de Over-representation y GSEA</h2>
<p>También podemos hacer la representación de los datos con distintos tipos de gráficas, que por ejemplo lo vamos a hacer con el dataset que hemos creado para KEGG: - Barplot</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representatition</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(kk, <span class="at">showCategory =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-121-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representatition</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(kk, <span class="at">q_score =</span> <span class="sc">-</span><span class="fu">log</span>(p.adjust, <span class="at">base=</span><span class="dv">10</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot</span>(<span class="at">x=</span><span class="st">"q_score"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-122-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Dot plot (bubble-plot)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representation y GSEA</span></span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="co">#En este caso, imput over-representation</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dotplot</span>(kk, <span class="at">showCategory=</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"dotplot for Kegg GSEA </span><span class="sc">\n</span><span class="st"> Analisis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-123-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput GSEA</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dotplot</span>(mkk2, <span class="at">showCategory=</span><span class="dv">10</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"dotplot for Kegg GSEA </span><span class="sc">\n</span><span class="st"> Analisis"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-124-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Gene-Concept Network:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representatition y GSEA</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="do">## convert gene ID to Symbol</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>edox <span class="ot">&lt;-</span> <span class="fu">setReadable</span>(mkk2, <span class="st">'org.Hs.eg.db'</span>, <span class="st">'ENTREZID'</span>)</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cnetplot</span>(edox, <span class="at">foldChange=</span>ENTREZ_geneList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-125-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="do">## categorySize can be scaled by 'pvalue' or 'geneNum'</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cnetplot</span>(edox, <span class="at">categorySize=</span><span class="st">"pvalue"</span>, <span class="at">foldChange=</span>geneList)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-126-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cnetplot</span>(edox, <span class="at">foldChange=</span>ENTREZ_geneList, <span class="at">circular =</span> <span class="cn">TRUE</span>, <span class="at">colorEdge =</span> <span class="cn">TRUE</span>,</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>         <span class="at">cex.params =</span> <span class="fu">list</span>(<span class="at">category_node =</span> <span class="fl">0.5</span>, <span class="at">gene_node =</span> <span class="fl">0.25</span>, <span class="at">category_label =</span> <span class="dv">1</span>, <span class="at">gene_label =</span> <span class="fl">0.3</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-127-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Heatmap-like functional classification</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representatition y GSEA</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a><span class="fu">heatplot</span>(edox, <span class="at">foldChange=</span>ENTREZ_geneList, <span class="at">showCategory=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-128-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Tree plot: realiza un clasificación no supervisada de los téminos enriquecidos en base a las similitudes entre términos</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput Over-representatition y GSEA</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>edox2 <span class="ot">&lt;-</span> <span class="fu">pairwise_termsim</span>(edox)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="fu">treeplot</span>(edox2, <span class="at">hclust_method =</span> <span class="st">"average"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-129-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<ul>
<li>Ridgeline</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co">#imput GSEA</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ridgeplot</span>(</span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>  mkk2,</span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">showCategory =</span> <span class="dv">8</span>,</span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">fill =</span> <span class="st">"p.adjust"</span>,</span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">core_enrichment =</span> <span class="cn">TRUE</span>,</span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_format =</span> <span class="dv">40</span>,</span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">orderBy =</span> <span class="st">"NES"</span>,</span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">decreasing =</span> <span class="cn">FALSE</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.299</code></pre>
</div>
<div class="cell-output-display">
<p><img src="RNAseq_files/figure-html/unnamed-chunk-130-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>